---
import PublicLayout from '@/layouts/PublicLayout.astro';
import ProductCard from '@/components/product/ProductCard.astro';
import { supabase } from '@/lib/supabase';

// Check Global Settings
const { data: offersSettings } = await supabase
  .from('app_settings')
  .select('value')
  .eq('key', 'offers_enabled')
  .single();

if (offersSettings?.value === false) {
    return Astro.redirect('/');
}

// Fetch featured offers
const { data: featuredOffersData } = await supabase
  .from('app_settings')
  .select('value')
  .eq('key', 'featured_offers')
  .single();

const featuredOffers = featuredOffersData?.value || [];

console.log('[ofertas.astro] featuredOffersData:', featuredOffersData);
console.log('[ofertas.astro] featuredOffers:', featuredOffers);
console.log('[ofertas.astro] featuredOffers.length:', featuredOffers?.length);

// Fetch the products in rebaja
let rebajasProducts = [];
if (Array.isArray(featuredOffers) && featuredOffers.length > 0) {
  const offersWithDefaults = featuredOffers.map((o: any) => ({
    id: o.id || o,
    discount: o.discount || 0
  }));
  
  const offerIds = offersWithDefaults.map((o: any) => o.id);
  
  const { data: products } = await supabase
    .from('products')
    .select('*, brand:brands(name)')
    .in('id', offerIds);
  
  // Order by the order in featuredOffers and add discount info
  rebajasProducts = offersWithDefaults
    .map((offer: any) => {
      const product = products?.find((p: any) => p.id === offer.id);
      if (product) {
        return {
          ...product,
          discount: offer.discount || 0,
          discountedPrice: Math.round(product.price * (1 - (offer.discount || 0) / 100)),
          is_flash_sale: product.is_flash_sale || false,
          flash_sale_discount: product.flash_sale_discount || 0
        };
      }
      return null;
    })
    .filter(Boolean);
}

---

<PublicLayout title="Rebajas - Éclat Beauty">
  <div class="min-h-screen bg-white">
    {/* Header */}
    <div class="bg-gradient-to-r from-rose-100 to-pink-100 py-12 md:py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center">
          <span class="inline-block text-pink-500 text-[10px] uppercase tracking-[0.3em] mb-3 font-medium">Ofertas Exclusivas</span>
          <h1 class="text-4xl md:text-5xl font-sans font-bold text-black mb-4 uppercase">REBAJAS</h1>
          <p class="text-gray-600 text-lg">Tus favoritos al mejor precio. ¡Corre que vuelan!</p>
        </div>
      </div>
    </div>

    {/* Products Grid */}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-16">
      {rebajasProducts.length > 0 ? (
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 md:gap-6">
          {rebajasProducts.map((product: any) => (
            <ProductCard product={{
              ...product,
              brand: product.brand?.name || 'Marca'
            }} />
          ))}
        </div>
      ) : (
        <div class="text-center py-16">
          <p class="text-gray-500 text-lg mb-4">No hay productos en rebajas en este momento</p>
          <a href="/productos" class="inline-block text-[11px] font-medium uppercase tracking-[0.15em] text-black border-b border-black pb-1 hover:text-rose-600 hover:border-rose-600 transition-colors">
            Ver todos los productos
          </a>
        </div>
      )}
    </div>

    {/* Divider */}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="w-full h-px bg-black"></div>
    </div>
  </div>
</PublicLayout>
