---
export const prerender = false; // SSR

import AdminLayout from '@/layouts/AdminLayout.astro';
import { Dashboard } from '@/components/dashboard/Dashboard';
import { supabase } from '@/lib/supabase';
import {
  getTotalSalesMonth,
  getPendingOrdersCount,
  getTopSellingProduct,
  getReturnRate,
  getSalesLast7Days,
  getTopProducts,
  getOrderStatusDistribution,
} from '@/lib/dashboard';

// Fetch statistics
const { count: productCount } = await supabase
  .from('products')
  .select('*', { count: 'exact', head: true });

const { count: categoryCount } = await supabase
  .from('categories')
  .select('*', { count: 'exact', head: true });

const { data: recentProducts } = await supabase
  .from('products')
  .select('*')
  .order('created_at', { ascending: false })
  .limit(5);

// Fetch dashboard analytics data
const [
  totalSalesMonth,
  pendingOrders,
  topProduct,
  returnRate,
  salesLast7Days,
  topProducts,
  orderStatusDistribution,
] = await Promise.all([
  getTotalSalesMonth(),
  getPendingOrdersCount(),
  getTopSellingProduct(),
  getReturnRate(),
  getSalesLast7Days(),
  getTopProducts(),
  getOrderStatusDistribution(),
]);
---

<AdminLayout title="Panel de Control">
  <div class="space-y-16">
    <!-- 1. PANEL DE CONTROL HEADER -->
    <div class="border-b border-admin-border pb-8">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-admin-text">Panel de Control</h1>
      </div>

      {/* Stats Grid */}
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-gradient-to-br from-admin-primary to-blue-600 text-white p-6 rounded-lg shadow-md flex items-center justify-between">
          <div>
            <p class="text-xs font-semibold uppercase tracking-wide mb-2 opacity-90">Total Productos</p>
            <p class="text-4xl font-bold">{productCount || 0}</p>
          </div>
          <div class="opacity-30">
            <svg class="w-14 h-14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
          </div>
        </div>

        <div class="bg-gradient-to-br from-admin-success to-green-600 text-white p-6 rounded-lg shadow-md flex items-center justify-between">
          <div>
            <p class="text-xs font-semibold uppercase tracking-wide mb-2 opacity-90">Categorías</p>
            <p class="text-4xl font-bold">{categoryCount || 0}</p>
          </div>
          <div class="opacity-30">
            <svg class="w-14 h-14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
            </svg>
          </div>
        </div>

        <div class="bg-gradient-to-br from-admin-warning to-orange-600 text-white p-6 rounded-lg shadow-md flex items-center justify-between">
          <div>
            <p class="text-xs font-semibold uppercase tracking-wide mb-2 opacity-90">Inventario Total</p>
            <p class="text-4xl font-bold">
              {recentProducts?.reduce((sum, p) => sum + p.stock, 0) || 0}
            </p>
          </div>
          <div class="opacity-30">
            <svg class="w-14 h-14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. QUICK ACTIONS -->
    <div class="space-y-4">
      <h2 class="text-xl font-bold text-admin-text">Acciones Rápidas</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <a
          href="/admin/productos/nuevo"
          class="border border-admin-border bg-white p-5 rounded-lg hover:shadow-md transition-all flex items-center gap-4 group"
        >
          <div class="w-12 h-12 bg-admin-primary text-white flex items-center justify-center rounded-lg group-hover:bg-admin-primary-dark transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
          </div>
          <div>
            <p class="text-sm font-bold text-admin-text">Nuevo Producto</p>
            <p class="text-xs text-admin-text-muted">Añadir item al catálogo</p>
          </div>
        </a>

        <a
          href="/admin/pedidos"
          class="border border-admin-border bg-white p-5 rounded-lg hover:shadow-md transition-all flex items-center gap-4 group"
        >
          <div class="w-12 h-12 bg-admin-success text-white flex items-center justify-center rounded-lg group-hover:bg-admin-success-dark transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
            </svg>
          </div>
          <div>
            <p class="text-sm font-bold text-admin-text">Gestionar Pedidos</p>
            <p class="text-xs text-admin-text-muted">Ver y actualizar estado</p>
          </div>
        </a>

        <a
          href="/admin/productos"
          class="border border-admin-border bg-white p-5 rounded-lg hover:shadow-md transition-all flex items-center gap-4 group"
        >
          <div class="w-12 h-12 bg-admin-warning text-white flex items-center justify-center rounded-lg group-hover:bg-admin-warning-dark transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
            </svg>
          </div>
          <div>
            <p class="text-sm font-bold text-admin-text">Gestionar Productos</p>
            <p class="text-xs text-admin-text-muted">Ver inventario completo</p>
          </div>
        </a>
      </div>
    </div>

    <!-- 3. CREAR ATRIBUTOS -->
    <div class="space-y-4">
      <h2 class="text-xl font-bold text-admin-text">Crear Atributos</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <a
          href="/admin/subcategorias"
          class="border border-admin-border bg-white p-5 rounded-lg hover:shadow-md transition-all"
        >
          <h3 class="text-sm font-bold text-admin-text mb-2">Subcategorías</h3>
          <p class="text-xs text-admin-text-muted">Gestionar subcategorías y atributos de productos</p>
        </a>

        <a
          href="/admin/marcas"
          class="border border-admin-border bg-white p-5 rounded-lg hover:shadow-md transition-all"
        >
          <h3 class="text-sm font-bold text-admin-text mb-2">Marcas</h3>
          <p class="text-xs text-admin-text-muted">Crear y editar marcas de productos</p>
        </a>
      </div>
    </div>

    <!-- 4. DASHBOARD EJECUTIVO -->
    <div class="border-t border-admin-border pt-12 mt-12">
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-admin-text mb-2">Analytics</h1>
        <p class="text-base text-admin-text-muted">Análisis de ventas y desempeño</p>
      </div>

      <Dashboard
        client:load
        totalSalesMonth={totalSalesMonth}
        pendingOrders={pendingOrders}
        topProduct={topProduct}
        returnRate={returnRate}
        salesLast7Days={salesLast7Days}
        topProducts={topProducts}
        orderStatusDistribution={orderStatusDistribution}
      />
    </div>
  </div>
</AdminLayout>
