---
import PublicLayout from '@/layouts/PublicLayout.astro';
import ProductCard from '@/components/product/ProductCard.astro';
import { supabase } from '@/lib/supabase';

// Check Global Settings
const { data: offersSettings } = await supabase
  .from('app_settings')
  .select('value')
  .eq('key', 'offers_enabled')
  .single();

if (offersSettings?.value === false) {
    return Astro.redirect('/');
}

// Fetch featured offers
const { data: featuredOffersData } = await supabase
  .from('app_settings')
  .select('value')
  .eq('key', 'featured_offers')
  .single();

const featuredOffers = featuredOffersData?.value || [];

console.log('[ofertas.astro] featuredOffersData:', featuredOffersData);
console.log('[ofertas.astro] featuredOffers:', featuredOffers);
console.log('[ofertas.astro] featuredOffers.length:', featuredOffers?.length);

// Fetch the products in rebaja
let rebajasProducts = [];
if (Array.isArray(featuredOffers) && featuredOffers.length > 0) {
  const offersWithDefaults = featuredOffers.map((o: any) => ({
    id: o.id || o,
    discount: o.discount || 0
  }));
  
  const offerIds = offersWithDefaults.map((o: any) => o.id);
  
  const { data: products } = await supabase
    .from('products')
    .select('*, brand:brands(name, slug)')
    .in('id', offerIds);
  
  // Order by the order in featuredOffers and add discount info
  rebajasProducts = offersWithDefaults
    .map((offer: any) => {
      const product = products?.find((p: any) => p.id === offer.id);
      if (product) {
        return {
          ...product,
          discount: offer.discount || 0,
          discountedPrice: Math.round(product.price * (1 - (offer.discount || 0) / 100)),
          is_flash_sale: product.is_flash_sale || false,
          flash_sale_discount: product.flash_sale_discount || 0,
          brandName: product.brand?.name || 'Marca',
          brandSlug: product.brand?.slug || '',
          categoryId: String(product.category_id || ''),
        };
      }
      return null;
    })
    .filter(Boolean);
}

const { data: rbCategories } = await supabase.from('categories').select('*').order('name');
const { data: rbBrandsList } = await supabase.from('brands').select('*').order('name');
const rbPrices = (rebajasProducts as any[]).map((p: any) => p.discountedPrice || p.price).filter(Boolean);
const rbPriceMin = rbPrices.length ? Math.floor(Math.min(...rbPrices)) : 0;
const rbPriceMax = rbPrices.length ? Math.ceil(Math.max(...rbPrices)) : 1000;

---

<PublicLayout title="Rebajas - Éclat Beauty">
  <div class="min-h-screen bg-white">
    {/* Header */}
    <div class="bg-gradient-to-r from-rose-100 to-pink-100 py-12 md:py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center">
          <span class="inline-block text-pink-500 text-[10px] uppercase tracking-[0.3em] mb-3 font-medium">Ofertas Exclusivas</span>
          <h1 class="text-4xl md:text-5xl font-sans font-bold text-black mb-4 uppercase">REBAJAS</h1>
          <p class="text-gray-600 text-lg">Tus favoritos al mejor precio. ¡Corre que vuelan!</p>
        </div>
      </div>
    </div>

    {/* Products Grid */}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-16">
      {rebajasProducts.length > 0 ? (
        <div class="flex flex-col lg:flex-row gap-10">

          {/* Sidebar filtros completo */}
          <aside id="rb-sidebar" class="w-full lg:w-64 shrink-0 hidden md:block">
            <div id="rb-toggle-btn" class="border-b border-gray-200 pb-4 mb-6 flex justify-between items-center cursor-pointer group">
              <span id="rb-toggle-label" class="font-bold text-sm uppercase tracking-widest group-hover:text-gray-600">Ocultar Filtros</span>
              <svg id="rb-toggle-icon" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </div>
            <div id="rb-sidebar-content">
              {/* Marcas */}
              <div class="mb-6">
                <h3 id="rb-toggle-brand" class="font-bold text-sm uppercase mb-4 flex justify-between cursor-pointer">
                  Marcas
                  <svg id="rb-brand-arrow" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </h3>
                <div id="rb-brand-section">
                  <div class="relative mb-4">
                    <input type="text" id="rb-brand-search" placeholder="Buscar una marca" class="w-full border-b border-black py-2 pl-0 pr-8 text-sm focus:outline-none placeholder-gray-400 italic" />
                    <svg class="w-4 h-4 absolute right-0 top-3 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                  </div>
                  <div class="space-y-2 max-h-64 overflow-y-auto">
                    {rbBrandsList?.map((brand: any) => (
                      <label class="rb-brand-label flex items-center space-x-3 cursor-pointer group" data-brand-name={brand.name.toLowerCase()}>
                        <input type="checkbox" class="rb-brand-cb w-5 h-5 border-2 border-gray-300 rounded-none checked:bg-black checked:border-black focus:ring-0" data-brand-slug={brand.slug} />
                        <span class="text-sm text-black group-hover:underline">{brand.name}</span>
                      </label>
                    ))}
                  </div>
                </div>
              </div>
              {/* Precio */}
              <div class="mb-6">
                <h3 id="rb-toggle-price" class="font-bold text-sm uppercase mb-4 flex justify-between cursor-pointer">
                  Precio
                  <svg id="rb-price-arrow" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </h3>
                <div id="rb-price-section" class="space-y-4">
                  <div class="flex justify-between text-xs font-bold text-gray-600">
                    <span id="rb-price-min-label">{rbPriceMin}€</span>
                    <span id="rb-price-max-label">{rbPriceMax}€</span>
                  </div>
                  <input type="range" id="rb-range-min" min={rbPriceMin} max={rbPriceMax} value={rbPriceMin} class="w-full accent-black h-0.5 cursor-pointer" />
                  <input type="range" id="rb-range-max" min={rbPriceMin} max={rbPriceMax} value={rbPriceMax} class="w-full accent-black h-0.5 cursor-pointer" />
                  <div class="flex gap-2">
                    <div class="flex-1 border border-gray-300 px-2 py-1 flex items-center gap-1">
                      <span class="text-xs text-gray-400">€</span>
                      <input type="number" id="rb-input-min" value={rbPriceMin} min={rbPriceMin} max={rbPriceMax} class="w-full text-xs focus:outline-none" />
                    </div>
                    <div class="flex-1 border border-gray-300 px-2 py-1 flex items-center gap-1">
                      <span class="text-xs text-gray-400">€</span>
                      <input type="number" id="rb-input-max" value={rbPriceMax} min={rbPriceMin} max={rbPriceMax} class="w-full text-xs focus:outline-none" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </aside>

          {/* Grid */}
          <div class="flex-1">
            {/* Barra horizontal de categorías */}
            <div class="flex flex-wrap gap-2 mb-8">
              <button class="rb-cat-btn px-4 py-2 text-xs font-bold uppercase tracking-widest border border-black bg-black text-white hover:bg-white hover:text-black transition-colors" data-cat-id="all">Ver todos</button>
              {rbCategories?.map((cat: any) => (
                <button class="rb-cat-btn px-4 py-2 text-xs font-bold uppercase tracking-widest border border-black bg-white text-black hover:bg-black hover:text-white transition-colors" data-cat-id={cat.id}>{cat.name}</button>
              ))}
            </div>
            <p class="text-xs text-gray-500 uppercase tracking-widest mb-6 font-medium" id="rb-count">
              {(rebajasProducts as any[]).length} producto{(rebajasProducts as any[]).length !== 1 ? 's' : ''} en rebajas
            </p>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6" id="rb-grid">
              {(rebajasProducts as any[]).map((product: any) => (
                <div class="rb-card" data-brand-slug={product.brandSlug} data-category-id={product.categoryId} data-price={product.discountedPrice || product.price}>
                  <ProductCard product={{ ...product, brand: product.brandName }} />
                </div>
              ))}
            </div>
            <div id="rb-empty" class="hidden text-center py-16">
              <p class="text-gray-400 text-sm uppercase tracking-widest font-bold">Sin productos para los filtros seleccionados</p>
            </div>
          </div>
        </div>
      ) : (
        <div class="text-center py-16">
          <p class="text-gray-500 text-lg mb-4">No hay productos en rebajas en este momento</p>
          <a href="/productos" class="inline-block text-[11px] font-medium uppercase tracking-[0.15em] text-black border-b border-black pb-1 hover:text-rose-600 hover:border-rose-600 transition-colors">
            Ver todos los productos
          </a>
        </div>
      )}
    </div>

    {/* Divider */}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="w-full h-px bg-black"></div>
    </div>
  </div>
</PublicLayout>

<style>
  .rb-card.hidden { display: none; }
  .rb-cat-btn.rb-active-cat { background-color: #000 !important; color: #fff !important; }
</style>

<script define:vars={{ rbPriceMin, rbPriceMax }}>
  var rbSelectedCategory = 'all';
  var rbSelectedBrands = [];
  var rbCurrentMin = rbPriceMin;
  var rbCurrentMax = rbPriceMax;

  var cards = document.querySelectorAll('.rb-card');
  var countEl = document.getElementById('rb-count');
  var emptyEl = document.getElementById('rb-empty');
  var gridEl = document.getElementById('rb-grid');

  function applyFilters() {
    var visible = 0;
    cards.forEach(function(card) {
      var brand = card.dataset.brandSlug || '';
      var cat = String(card.dataset.categoryId || '');
      var price = parseInt(card.dataset.price || '0');
      var show =
        (rbSelectedBrands.length === 0 || rbSelectedBrands.includes(brand)) &&
        (rbSelectedCategory === 'all' || rbSelectedCategory === cat) &&
        price >= rbCurrentMin && price <= rbCurrentMax;
      card.classList.toggle('hidden', !show);
      if (show) visible++;
    });
    if (countEl) countEl.textContent = visible + ' producto' + (visible !== 1 ? 's' : '') + ' en rebajas';
    if (emptyEl) emptyEl.classList.toggle('hidden', visible > 0);
    if (gridEl) gridEl.classList.toggle('hidden', visible === 0);
  }

  // Toggle sidebar
  var rbSidebarOpen = true;
  var rbSidebarContent = document.getElementById('rb-sidebar-content');
  var rbToggleBtn = document.getElementById('rb-toggle-btn');
  var rbToggleLabel = document.getElementById('rb-toggle-label');
  var rbToggleIcon = document.getElementById('rb-toggle-icon');
  if (rbToggleBtn) {
    rbToggleBtn.addEventListener('click', function() {
      rbSidebarOpen = !rbSidebarOpen;
      if (rbSidebarContent) rbSidebarContent.classList.toggle('hidden', !rbSidebarOpen);
      if (rbToggleLabel) rbToggleLabel.textContent = rbSidebarOpen ? 'Ocultar Filtros' : 'Mostrar Filtros';
      if (rbToggleIcon) rbToggleIcon.style.transform = rbSidebarOpen ? '' : 'rotate(180deg)';
    });
  }

  // Collapsible sections
  [['rb-toggle-brand','rb-brand-section','rb-brand-arrow'],
   ['rb-toggle-price','rb-price-section','rb-price-arrow']].forEach(function(ids) {
    var btn = document.getElementById(ids[0]);
    var sec = document.getElementById(ids[1]);
    var arr = document.getElementById(ids[2]);
    var open = true;
    if (btn) btn.addEventListener('click', function() {
      open = !open;
      if (sec) sec.classList.toggle('hidden', !open);
      if (arr) arr.style.transform = open ? '' : 'rotate(-90deg)';
    });
  });

  // Category (horizontal bar)
  document.querySelectorAll('.rb-cat-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      rbSelectedCategory = btn.dataset.catId || 'all';
      document.querySelectorAll('.rb-cat-btn').forEach(function(b) {
        b.classList.toggle('rb-active-cat', b.dataset.catId === rbSelectedCategory);
      });
      applyFilters();
    });
  });

  // Brands
  document.querySelectorAll('.rb-brand-cb').forEach(function(cb) {
    cb.addEventListener('change', function() {
      var slug = cb.dataset.brandSlug || '';
      if (cb.checked) { if (!rbSelectedBrands.includes(slug)) rbSelectedBrands.push(slug); }
      else { rbSelectedBrands = rbSelectedBrands.filter(function(s) { return s !== slug; }); }
      applyFilters();
    });
  });

  // Brand search
  var rbBrandSearch = document.getElementById('rb-brand-search');
  if (rbBrandSearch) rbBrandSearch.addEventListener('input', function(e) {
    var q = e.target.value.toLowerCase();
    document.querySelectorAll('.rb-brand-label').forEach(function(label) {
      label.style.display = (label.dataset.brandName || '').includes(q) ? '' : 'none';
    });
  });

  // Price
  function updatePriceUI() {
    var lMin = document.getElementById('rb-price-min-label');
    var lMax = document.getElementById('rb-price-max-label');
    var rMin = document.getElementById('rb-range-min');
    var rMax = document.getElementById('rb-range-max');
    var iMin = document.getElementById('rb-input-min');
    var iMax = document.getElementById('rb-input-max');
    if (lMin) lMin.textContent = rbCurrentMin + '€';
    if (lMax) lMax.textContent = rbCurrentMax + '€';
    if (rMin) rMin.value = String(rbCurrentMin);
    if (rMax) rMax.value = String(rbCurrentMax);
    if (iMin) iMin.value = String(rbCurrentMin);
    if (iMax) iMax.value = String(rbCurrentMax);
  }
  var rbRMin = document.getElementById('rb-range-min');
  var rbRMax = document.getElementById('rb-range-max');
  var rbIMin = document.getElementById('rb-input-min');
  var rbIMax = document.getElementById('rb-input-max');
  if (rbRMin) rbRMin.addEventListener('input', function(e) { rbCurrentMin = Math.min(parseInt(e.target.value), rbCurrentMax - 1); updatePriceUI(); applyFilters(); });
  if (rbRMax) rbRMax.addEventListener('input', function(e) { rbCurrentMax = Math.max(parseInt(e.target.value), rbCurrentMin + 1); updatePriceUI(); applyFilters(); });
  if (rbIMin) rbIMin.addEventListener('change', function(e) { rbCurrentMin = Math.max(rbPriceMin, Math.min(parseInt(e.target.value)||rbPriceMin, rbCurrentMax-1)); updatePriceUI(); applyFilters(); });
  if (rbIMax) rbIMax.addEventListener('change', function(e) { rbCurrentMax = Math.min(rbPriceMax, Math.max(parseInt(e.target.value)||rbPriceMax, rbCurrentMin+1)); updatePriceUI(); applyFilters(); });
</script>
