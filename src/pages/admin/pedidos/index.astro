---
export const prerender = false; // SSR

import AdminLayout from '@/layouts/AdminLayout.astro';
import AdminOrderRow from '@/components/admin/AdminOrderRow';
import { supabase } from '@/lib/supabase';

// Fetch orders with items
const { data: orders, error } = await supabase
  .from('orders')
  .select(`
    id,
    created_at,
    status,
    total_amount,
    user_id,
    guest_email,
    order_items (
      id,
      quantity,
      price_at_purchase,
      product:product_id (
        id,
        name,
        stock
      )
    )
  `)
  .order('created_at', { ascending: false });

if (error) {
  console.error('Error fetching orders:', error);
}

const orderList = orders || [];
---

<AdminLayout title="Pedidos">
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">Gesti√≥n de Pedidos</h1>
    <p class="text-gray-600">Total: {orderList.length} pedidos</p>
  </div>

  <!-- Orders Table -->
  <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
    <table class="w-full">
      <thead class="bg-gray-50 border-b border-gray-100">
        <tr>
          <th class="py-3 px-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">ID</th>
          <th class="py-3 px-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Fecha</th>
          <th class="py-3 px-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Cliente</th>
          <th class="py-3 px-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Productos</th>
          <th class="py-3 px-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Total</th>
          <th class="py-3 px-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Estado</th>
          <th class="py-3 px-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Acciones</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {orderList.map((order) => (
          <AdminOrderRow client:load order={order} />
        ))}
      </tbody>
    </table>

    {orderList.length === 0 && (
      <div class="p-6 text-center text-gray-400 text-sm">
        <p>No hay pedidos disponibles</p>
      </div>
    )}
  </div>
</AdminLayout>
