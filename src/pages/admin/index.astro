---
export const prerender = false; // SSR

import AdminLayout from '@/layouts/AdminLayout.astro';
import { Dashboard } from '@/components/dashboard/Dashboard';
import { supabase } from '@/lib/supabase';
import {
  getTotalSalesMonth,
  getPendingOrdersCount,
  getTopSellingProduct,
  getReturnRate,
  getSalesLast7Days,
  getTopProducts,
  getOrderStatusDistribution,
} from '@/lib/dashboard';

// Fetch statistics
const { count: productCount } = await supabase
  .from('products')
  .select('*', { count: 'exact', head: true });

const { count: categoryCount } = await supabase
  .from('categories')
  .select('*', { count: 'exact', head: true });

const { data: recentProducts } = await supabase
  .from('products')
  .select('*')
  .order('created_at', { ascending: false })
  .limit(5);

const totalStock = recentProducts?.reduce((sum, p) => sum + (p.stock || 0), 0) || 0;

// Fetch dashboard analytics data
const [
  totalSalesMonth,
  pendingOrders,
  topProduct,
  returnRate,
  salesLast7Days,
  topProducts,
  orderStatusDistribution,
] = await Promise.all([
  getTotalSalesMonth(),
  getPendingOrdersCount(),
  getTopSellingProduct(),
  getReturnRate(),
  getSalesLast7Days(),
  getTopProducts(),
  getOrderStatusDistribution(),
]);

const now = new Date();
const dateStr = now.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
---

<AdminLayout title="Panel de Control">
  <div class="space-y-10 max-w-7xl">

    <!-- HEADER -->
    <div class="flex items-end justify-between border-b border-gray-200 pb-6">
      <div>
        <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">{dateStr}</p>
        <h1 class="text-3xl font-black text-black tracking-tight">Panel de Control</h1>
      </div>
      <a
        href="/admin/productos/nuevo"
        class="inline-flex items-center gap-2 bg-black text-white px-5 py-2.5 text-xs font-bold uppercase tracking-wider hover:bg-pink-500 transition-colors duration-200"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Nuevo Producto
      </a>
    </div>

    <!-- KPI STATS -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
      <!-- Ventas mes -->
      <div class="bg-black text-white p-6 flex flex-col justify-between min-h-[130px]">
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400">Ventas este mes</p>
        <div>
          <p class="text-3xl font-black mt-2">{typeof totalSalesMonth === 'number' ? `€${(totalSalesMonth/100).toFixed(0)}` : '€0'}</p>
          <div class="w-8 h-0.5 bg-pink-500 mt-3"></div>
        </div>
      </div>

      <!-- Pedidos pendientes -->
      <div class="bg-white border border-gray-200 p-6 flex flex-col justify-between min-h-[130px]">
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400">Pedidos pendientes</p>
        <div>
          <p class="text-3xl font-black text-black mt-2">{pendingOrders || 0}</p>
          <a href="/admin/pedidos" class="text-[10px] text-pink-500 font-bold uppercase tracking-wider mt-3 inline-block hover:underline">Ver pedidos &rarr;</a>
        </div>
      </div>

      <!-- Productos -->
      <div class="bg-white border border-gray-200 p-6 flex flex-col justify-between min-h-[130px]">
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400">Total productos</p>
        <div>
          <p class="text-3xl font-black text-black mt-2">{productCount || 0}</p>
          <p class="text-[10px] text-gray-400 mt-3 uppercase tracking-wider">{categoryCount || 0} categorias</p>
        </div>
      </div>

      <!-- Stock total -->
      <div class="bg-white border border-gray-200 p-6 flex flex-col justify-between min-h-[130px]">
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400">Stock total</p>
        <div>
          <p class="text-3xl font-black text-black mt-2">{totalStock}</p>
          <p class="text-[10px] text-gray-400 mt-3 uppercase tracking-wider">unidades</p>
        </div>
      </div>
    </div>

    <!-- ACCIONES RAPIDAS + TOP PRODUCTO -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Acciones rapidas (2/3) -->
      <div class="lg:col-span-2 space-y-3">
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-4">Acciones rapidas</p>
        <div class="grid grid-cols-2 gap-3">
          <a href="/admin/productos/nuevo" class="group flex items-center gap-4 bg-white border border-gray-200 p-5 hover:border-black transition-colors duration-200">
            <div class="w-10 h-10 bg-gray-100 group-hover:bg-black flex items-center justify-center transition-colors duration-200 flex-shrink-0">
              <svg class="w-5 h-5 text-black group-hover:text-white transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
            </div>
            <div>
              <p class="text-sm font-bold text-black">Nuevo Producto</p>
              <p class="text-xs text-gray-400 mt-0.5">Añadir al catalogo</p>
            </div>
          </a>

          <a href="/admin/pedidos" class="group flex items-center gap-4 bg-white border border-gray-200 p-5 hover:border-black transition-colors duration-200">
            <div class="w-10 h-10 bg-gray-100 group-hover:bg-black flex items-center justify-center transition-colors duration-200 flex-shrink-0">
              <svg class="w-5 h-5 text-black group-hover:text-white transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
              </svg>
            </div>
            <div>
              <p class="text-sm font-bold text-black">Pedidos</p>
              <p class="text-xs text-gray-400 mt-0.5">Ver y gestionar</p>
            </div>
          </a>

          <a href="/admin/productos" class="group flex items-center gap-4 bg-white border border-gray-200 p-5 hover:border-black transition-colors duration-200">
            <div class="w-10 h-10 bg-gray-100 group-hover:bg-black flex items-center justify-center transition-colors duration-200 flex-shrink-0">
              <svg class="w-5 h-5 text-black group-hover:text-white transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
              </svg>
            </div>
            <div>
              <p class="text-sm font-bold text-black">Productos</p>
              <p class="text-xs text-gray-400 mt-0.5">Inventario completo</p>
            </div>
          </a>

          <a href="/admin/ofertas-flash" class="group flex items-center gap-4 bg-white border border-gray-200 p-5 hover:border-black transition-colors duration-200">
            <div class="w-10 h-10 bg-gray-100 group-hover:bg-pink-500 flex items-center justify-center transition-colors duration-200 flex-shrink-0">
              <svg class="w-5 h-5 text-black group-hover:text-white transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
            </div>
            <div>
              <p class="text-sm font-bold text-black">Ofertas Flash</p>
              <p class="text-xs text-gray-400 mt-0.5">Gestionar descuentos</p>
            </div>
          </a>

          <a href="/admin/rebajas" class="group flex items-center gap-4 bg-white border border-gray-200 p-5 hover:border-black transition-colors duration-200">
            <div class="w-10 h-10 bg-gray-100 group-hover:bg-pink-500 flex items-center justify-center transition-colors duration-200 flex-shrink-0">
              <svg class="w-5 h-5 text-black group-hover:text-white transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
              </svg>
            </div>
            <div>
              <p class="text-sm font-bold text-black">Rebajas</p>
              <p class="text-xs text-gray-400 mt-0.5">Gestion de rebajas</p>
            </div>
          </a>

          <a href="/admin/configuracion" class="group flex items-center gap-4 bg-white border border-gray-200 p-5 hover:border-black transition-colors duration-200">
            <div class="w-10 h-10 bg-gray-100 group-hover:bg-black flex items-center justify-center transition-colors duration-200 flex-shrink-0">
              <svg class="w-5 h-5 text-black group-hover:text-white transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
            </div>
            <div>
              <p class="text-sm font-bold text-black">Configuracion</p>
              <p class="text-xs text-gray-400 mt-0.5">Ajustes de la tienda</p>
            </div>
          </a>
        </div>
      </div>

      <!-- Top producto + tasa devolucion (1/3) -->
      <div class="space-y-3">
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-4">Destacado</p>

        {topProduct && (
          <div class="bg-black text-white p-6">
            <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-3">Producto mas vendido</p>
            <p class="text-lg font-black leading-tight">{topProduct.name}</p>
            <p class="text-pink-400 text-sm font-bold mt-2">{topProduct.quantity || 0} unidades</p>
            <div class="w-8 h-0.5 bg-pink-500 mt-4"></div>
          </div>
        )}

        <div class="bg-white border border-gray-200 p-6">
          <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-3">Tasa devoluciones</p>
          <p class="text-3xl font-black text-black">{typeof returnRate === 'number' ? `${returnRate.toFixed(1)}%` : '0%'}</p>
          <div class="mt-3 w-full bg-gray-100 h-1.5">
            <div class="bg-pink-500 h-1.5 transition-all" style={`width: ${Math.min(returnRate || 0, 100)}%`}></div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <a href="/admin/atributos" class="bg-white border border-gray-200 p-4 hover:border-black transition-colors group">
            <p class="text-xs font-bold text-black group-hover:text-pink-500 transition-colors">Subcategorias</p>
            <p class="text-[10px] text-gray-400 mt-1">Gestionar</p>
          </a>
          <a href="/admin/marcas" class="bg-white border border-gray-200 p-4 hover:border-black transition-colors group">
            <p class="text-xs font-bold text-black group-hover:text-pink-500 transition-colors">Marcas</p>
            <p class="text-[10px] text-gray-400 mt-1">Gestionar</p>
          </a>
        </div>
      </div>
    </div>

    <!-- ANALYTICS -->
    <div class="border-t border-gray-200 pt-10">
      <div class="flex items-end justify-between mb-8">
        <div>
          <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-1">Rendimiento</p>
          <h2 class="text-2xl font-black text-black">Analytics</h2>
        </div>
      </div>

      <Dashboard
        client:load
        totalSalesMonth={totalSalesMonth}
        pendingOrders={pendingOrders}
        topProduct={topProduct}
        returnRate={returnRate}
        salesLast7Days={salesLast7Days}
        topProducts={topProducts}
        orderStatusDistribution={orderStatusDistribution}
      />
    </div>

  </div>
</AdminLayout>
