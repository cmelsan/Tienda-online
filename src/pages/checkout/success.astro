---
import PublicLayout from '@/layouts/PublicLayout.astro';
import Button from '@/components/ui/Button.astro';
import ClearCartOnSuccess from '@/components/checkout/ClearCartOnSuccess';

const { searchParams } = Astro.url;
const email = searchParams.get('email');
const orderId = searchParams.get('orderId');
---

<PublicLayout title="Compra Realizada | ÉCLAT" description="Gracias por tu compra">
  {/* Clear cart on component mount */}
  <ClearCartOnSuccess client:load />
  
  <script>
    // Limpiar carrito después de pago exitoso
    // El cupón ya se limpió de memoria automáticamente durante checkout
    if (typeof window !== 'undefined') {
      // Registrar en console
      const cartData = localStorage.getItem('eclat-cart:');
      
      console.log('[Success Page] Iniciando limpieza post-pago:', {
        hasCart: !!cartData,
        timestamp: new Date().toISOString()
      });

      let itemsCount = 0;
      let discountApplied = 0;

      // Limpiar carrito
      if (cartData) {
        try {
          const cart = JSON.parse(cartData);
          itemsCount = Object.keys(cart).length;
          console.log('[Success Page] Carrito vaciado - Items:', itemsCount);
        } catch (e) {
          console.warn('[Success Page] No se pudo parsear carrito');
        }
      }
      localStorage.removeItem('eclat-cart:');

      // Verificar que está limpio
      const cartAfter = localStorage.getItem('eclat-cart:');
      
      console.log('[Success Page] VERIFICACIÓN FINAL:', {
        cartLimpio: !cartAfter,
        timestamp: new Date().toISOString()
      });

      // Confirmar al servidor que se limpió el carrito
      const orderId = new URLSearchParams(window.location.search).get('orderId');
      const email = new URLSearchParams(window.location.search).get('email');
      
      if (orderId) {
        fetch('/api/checkout/confirm-clear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            orderId,
            email,
            itemsCount,
            discountApplied
          })
        }).catch(err => console.warn('[Success Page] No se pudo confirmar limpieza:', err));
      }
    }
  </script>
  <div class="min-h-[80vh] flex items-center justify-center bg-[#faf9f7] py-16 px-4">
    <div class="max-w-lg w-full text-center">

      <!-- Icono animado -->
      <div class="relative mx-auto mb-8 w-24 h-24">
        <div class="absolute inset-0 rounded-full bg-rose-50 animate-ping opacity-30"></div>
        <div class="relative flex items-center justify-center w-24 h-24 rounded-full bg-gradient-to-br from-rose-100 to-pink-50 border border-rose-200 shadow-md">
          <svg class="h-11 w-11 text-rose-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
          </svg>
        </div>
      </div>

      <!-- Título -->
      <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight mb-2">¡Pedido confirmado!</h1>
      <p class="text-gray-500 text-sm mb-8">
        Gracias por tu compra en ÉCLAT Beauty.
        {email && (
          <span> Recibirás un email en <strong class="text-gray-800">{email}</strong>.</span>
        )}
      </p>

      <!-- Número de pedido -->
      {orderId && (
        <div class="mb-8 mx-auto max-w-xs">
          <div class="bg-white border border-gray-200 rounded-xl px-6 py-4 shadow-sm">
            <p class="text-[10px] text-gray-400 uppercase tracking-widest font-semibold mb-1">Número de pedido</p>
            <p class="text-xl font-bold text-gray-900 font-mono tracking-wide" id="orderNumber">Cargando...</p>
          </div>
        </div>
      )}

      <script>
        if (typeof window !== 'undefined') {
          const el = document.getElementById('orderNumber');
          if (el) {
            const n = localStorage.getItem('eclat:lastOrderNumber');
            el.textContent = n ? `#${n}` : '#N/A';
          }
        }
      </script>

      <!-- Pasos que siguen -->
      <div class="mb-10 grid grid-cols-3 gap-4 text-center">
        <div class="flex flex-col items-center gap-2">
          <div class="w-10 h-10 rounded-full bg-rose-50 border border-rose-100 flex items-center justify-center">
            <svg class="w-5 h-5 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
          </div>
          <p class="text-[11px] text-gray-500 leading-tight">Email de<br/>confirmación</p>
        </div>
        <div class="flex flex-col items-center gap-2">
          <div class="w-10 h-10 rounded-full bg-rose-50 border border-rose-100 flex items-center justify-center">
            <svg class="w-5 h-5 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
            </svg>
          </div>
          <p class="text-[11px] text-gray-500 leading-tight">Preparación<br/>del pedido</p>
        </div>
        <div class="flex flex-col items-center gap-2">
          <div class="w-10 h-10 rounded-full bg-rose-50 border border-rose-100 flex items-center justify-center">
            <svg class="w-5 h-5 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"/>
            </svg>
          </div>
          <p class="text-[11px] text-gray-500 leading-tight">Entrega en<br/>tu domicilio</p>
        </div>
      </div>

      <!-- CTAs -->
      <div class="space-y-3">
        <a href="/mi-cuenta/pedidos" class="flex items-center justify-center gap-2 w-full bg-black text-white px-8 py-4 text-xs font-bold uppercase tracking-widest hover:bg-gray-900 transition-colors shadow-md">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          </svg>
          Ver mis pedidos
        </a>
        <a href="/" class="flex items-center justify-center gap-2 w-full border border-gray-200 bg-white text-gray-700 px-8 py-3.5 text-xs font-bold uppercase tracking-widest hover:bg-gray-50 transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"/>
          </svg>
          Seguir comprando
        </a>
      </div>

      <!-- Footer note -->
      <p class="mt-8 text-[11px] text-gray-400">
        ¿No has recibido el email? Revisa spam o <a href="/contacto" class="underline hover:text-gray-700 transition-colors">contáctanos</a>.
      </p>

    </div>
  </div>
</PublicLayout>
