---
export const prerender = false;
import AdminLayout from '@/layouts/AdminLayout.astro';
import { supabase } from '@/lib/supabase';

const { data: coupons } = await supabase
  .from('coupons')
  .select('*')
  .order('created_at', { ascending: false });

const couponList = coupons || [];
const totalCoupons = couponList.length;
const activeCoupons = couponList.filter(c => c.is_active).length;
const inactiveCoupons = couponList.filter(c => !c.is_active).length;
const percentCoupons = couponList.filter(c => c.discount_type === 'percentage').length;

function formatValue(coupon: any) {
  return coupon.discount_type === 'percentage'
    ? `${coupon.discount_value}%`
    : `€${(coupon.discount_value / 100).toFixed(2)}`;
}

function formatUso(coupon: any) {
  return coupon.max_uses ? `${coupon.current_uses} / ${coupon.max_uses}` : 'Ilimitado';
}

function formatFecha(coupon: any) {
  return new Date(coupon.valid_until || '2099-12-31').toLocaleDateString('es-ES');
}
---

<AdminLayout title="Gestión de Cupones">
  <!-- Header -->
  <div class="mb-8">
    <div class="flex items-end justify-between mb-6">
      <div>
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-1">Promociones</p>
        <p class="text-xs text-gray-400">Gestiona codigos de descuento</p>
      </div>
      <a
        href="/admin/cupones/nuevo"
        class="bg-black text-white px-6 py-3 text-[10px] font-bold uppercase tracking-widest hover:bg-pink-500 transition-colors"
      >
        Nuevo Cupon
      </a>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
      <div class="bg-black text-white p-4">
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2">Total</p>
        <p class="text-3xl font-black">{totalCoupons}</p>
        <div class="w-6 h-0.5 bg-pink-500 mt-2"></div>
      </div>
      <div class="bg-white border border-gray-200 p-4">
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2">Activos</p>
        <p class="text-2xl font-black text-black">{activeCoupons}</p>
      </div>
      <div class="bg-white border border-gray-200 p-4">
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2">Inactivos</p>
        <p class="text-2xl font-black text-black">{inactiveCoupons}</p>
      </div>
      <div class="bg-white border border-gray-200 p-4">
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2">Por porcentaje</p>
        <p class="text-2xl font-black text-black">{percentCoupons}</p>
      </div>
    </div>
  </div>

  <!-- Mensajes -->
  <div id="message" class="hidden mb-4 p-3 bg-black text-white text-[10px] font-bold uppercase tracking-widest">
    <span id="messageText">Cupon eliminado correctamente</span>
  </div>
  <div id="error" class="hidden mb-4 p-3 bg-red-50 border border-red-200 text-red-700 text-[10px] font-bold uppercase tracking-widest">
    <span id="errorText">Error</span>
  </div>

  <!-- Buscador -->
  <div class="mb-4">
    <div class="relative">
      <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0z"/>
      </svg>
      <input
        id="search-cupones"
        type="text"
        placeholder="Buscar por código o descripción..."
        class="w-full pl-11 pr-4 py-3 bg-white border border-gray-200 text-sm placeholder-gray-400 focus:outline-none focus:border-black transition-colors"
      />
    </div>
    <p id="search-count-cupones" class="text-[10px] text-gray-400 mt-2 hidden uppercase tracking-widest"></p>
  </div>

  <!-- Tabla -->
  {couponList.length > 0 ? (
    <div class="bg-white border border-gray-200 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-black text-white">
            <tr>
              <th class="text-left py-3 px-4 text-[10px] font-bold uppercase tracking-widest">Codigo</th>
              <th class="text-left py-3 px-4 text-[10px] font-bold uppercase tracking-widest">Descripcion</th>
              <th class="text-left py-3 px-4 text-[10px] font-bold uppercase tracking-widest">Tipo</th>
              <th class="text-left py-3 px-4 text-[10px] font-bold uppercase tracking-widest">Valor</th>
              <th class="text-left py-3 px-4 text-[10px] font-bold uppercase tracking-widest">Uso</th>
              <th class="text-left py-3 px-4 text-[10px] font-bold uppercase tracking-widest">Vigencia</th>
              <th class="text-left py-3 px-4 text-[10px] font-bold uppercase tracking-widest">Estado</th>
              <th class="text-left py-3 px-4 text-[10px] font-bold uppercase tracking-widest">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {couponList.map((coupon) => (
              <tr
                class="border-b border-gray-100 hover:bg-gray-50 transition-colors"
                data-search={`${coupon.code} ${coupon.description || ''}`.toLowerCase()}
              >
                <td class="py-4 px-4">
                  <span class="text-xs font-black text-black tracking-tight">{coupon.code}</span>
                </td>
                <td class="py-4 px-4 text-xs text-gray-500 max-w-[200px] truncate">
                  {coupon.description || <span class="text-gray-300">—</span>}
                </td>
                <td class="py-4 px-4">
                  <span class="text-[10px] font-bold uppercase tracking-wide text-gray-500 border border-gray-200 px-2 py-1">
                    {coupon.discount_type === 'percentage' ? '%' : 'EUR'}
                  </span>
                </td>
                <td class="py-4 px-4">
                  <span class="text-xs font-black text-black">{formatValue(coupon)}</span>
                </td>
                <td class="py-4 px-4 text-xs text-gray-500">{formatUso(coupon)}</td>
                <td class="py-4 px-4 text-xs text-gray-500">{formatFecha(coupon)}</td>
                <td class="py-4 px-4">
                  <span class={`text-[10px] font-bold uppercase tracking-wide px-2.5 py-1 ${coupon.is_active ? 'bg-black text-white' : 'bg-gray-100 text-gray-400 border border-gray-200'}`}>
                    {coupon.is_active ? 'Activo' : 'Inactivo'}
                  </span>
                </td>
                <td class="py-4 px-4">
                  <div class="flex items-center gap-4">
                    <a
                      href={`/admin/cupones/editar/${coupon.id}`}
                      class="text-[11px] font-bold text-black hover:text-pink-500 transition-colors uppercase tracking-wide"
                    >
                      Editar
                    </a>
                    <button
                      class="delete-coupon text-[11px] font-bold text-gray-400 hover:text-red-500 transition-colors uppercase tracking-wide"
                      data-id={coupon.id}
                    >
                      Eliminar
                    </button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  ) : (
    <div class="bg-white border border-gray-200 p-16 text-center">
      <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400">Sin cupones</p>
      <p class="text-xs text-gray-400 mt-1 mb-6">Crea tu primer codigo de descuento</p>
      <a
        href="/admin/cupones/nuevo"
        class="inline-block bg-black text-white px-6 py-3 text-[10px] font-bold uppercase tracking-widest hover:bg-pink-500 transition-colors"
      >
        Crear Cupon
      </a>
    </div>
  )}
</AdminLayout>

<script>
  const deleteButtons = document.querySelectorAll('.delete-coupon') as NodeListOf<HTMLButtonElement>;
  const messageDiv = document.getElementById('message') as HTMLDivElement;
  const errorDiv = document.getElementById('error') as HTMLDivElement;
  const messageText = document.getElementById('messageText') as HTMLSpanElement;
  const errorText = document.getElementById('errorText') as HTMLSpanElement;

  deleteButtons.forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();

      if (!confirm('Eliminar este cupon?')) return;

      const couponId = btn.getAttribute('data-id');
      if (!couponId) return;

      messageDiv.classList.add('hidden');
      errorDiv.classList.add('hidden');

      try {
        const response = await fetch(`/api/admin/coupons/${couponId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
        });

        const result = await response.json();

        if (response.ok) {
          messageText.textContent = 'Cupon eliminado correctamente';
          messageDiv.classList.remove('hidden');
          setTimeout(() => { window.location.href = '/admin/cupones'; }, 1500);
        } else {
          errorText.textContent = result.error || 'Error al eliminar el cupon';
          errorDiv.classList.remove('hidden');
        }
      } catch (error) {
        errorText.textContent = 'Error de conexion';
        errorDiv.classList.remove('hidden');
      }
    });
  });

  // Búsqueda
  const searchCupones = document.getElementById('search-cupones') as HTMLInputElement;
  const countCupones = document.getElementById('search-count-cupones') as HTMLParagraphElement;
  const couponRows = document.querySelectorAll<HTMLTableRowElement>('tbody tr[data-search]');

  searchCupones?.addEventListener('input', () => {
    const q = searchCupones.value.toLowerCase().trim();
    let visible = 0;

    couponRows.forEach(row => {
      const match = !q || (row.dataset.search || '').includes(q);
      row.style.display = match ? '' : 'none';
      if (match) visible++;
    });

    if (q) {
      countCupones.textContent = `${visible} cupón${visible !== 1 ? 'es' : ''} encontrado${visible !== 1 ? 's' : ''}`;
      countCupones.classList.remove('hidden');
    } else {
      countCupones.classList.add('hidden');
    }
  });
</script>
