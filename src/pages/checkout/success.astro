---
import PublicLayout from '@/layouts/PublicLayout.astro';
import Button from '@/components/ui/Button.astro';
import ClearCartOnSuccess from '@/components/checkout/ClearCartOnSuccess';
import Stripe from 'stripe';
import { createClient } from '@supabase/supabase-js';
import { sendEmail, getOrderConfirmationTemplate } from '@/lib/brevo';
import { createSaleInvoice, fetchInvoiceAsAttachment } from '@/lib/invoices';

const { searchParams } = Astro.url;
const sessionId = searchParams.get('session_id');

let email: string | null = null;
let orderNumber: string | null = null;
let emailSentResult: string = 'not-attempted';

if (sessionId) {
  try {
    const stripeSecretKey = import.meta.env.STRIPE_SECRET_KEY;
    const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
    const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

    if (stripeSecretKey && supabaseUrl && supabaseAnonKey) {
      const stripe = new Stripe(stripeSecretKey, { apiVersion: '2025-12-15.clover' });
      const supabase = createClient(supabaseUrl, supabaseAnonKey);

      // 1. Retrieve Stripe session to get orderId and customerEmail
      const session = await stripe.checkout.sessions.retrieve(sessionId);
      const orderId = session.metadata?.orderId;
      const customerEmail = session.customer_email;
      email = customerEmail;

      if (orderId && customerEmail) {
        // 2. Fetch order from Supabase
        const { data: orderData } = await supabase
          .from('orders')
          .select('*')
          .eq('id', orderId)
          .single();

        if (orderData) {
          orderNumber = orderData.order_number || null;

          // 3. Deduplication: skip if email already sent
          if (!orderData.email_sent) {
            // 4. Fetch order items
            const { data: itemsData } = await supabase
              .from('order_items')
              .select('*, products(name)')
              .eq('order_id', orderId);

            const emailItems = (itemsData || []).map((item: any) => ({
              product_id: item.product_id,
              name: item.products?.name || 'Producto',
              quantity: item.quantity,
              price: item.price_at_purchase,
            }));

            // 5. Create invoice if not exists, get attachment
            let invoiceAttachment: { content: string; name: string } | null = null;
            try {
              const invoiceResult = await createSaleInvoice(supabase, orderId, sessionId);
              if (invoiceResult.success && invoiceResult.invoice_id) {
                invoiceAttachment = await fetchInvoiceAsAttachment(supabase, invoiceResult.invoice_id);
              }
            } catch (invErr: any) {
              console.warn('[Success] Invoice creation skipped:', invErr.message);
            }

            // 6. Send confirmation email
            const customerName = orderData.customer_name || 'Cliente';
            const htmlContent = getOrderConfirmationTemplate(
              orderData.order_number,
              customerName,
              emailItems,
              orderData.total_amount
            );

            const emailResult = await sendEmail({
              to: customerEmail,
              subject: `游닍 Pedido confirmado #${orderData.order_number}`,
              htmlContent,
              ...(invoiceAttachment ? { attachments: [invoiceAttachment] } : {}),
            });

            if (emailResult.success) {
              emailSentResult = 'sent';
              console.log('[Success] Confirmation email sent:', emailResult.messageId);
              // 7. Mark email as sent to avoid webhook sending it again
              await supabase
                .from('orders')
                .update({ email_sent: true })
                .eq('id', orderId);
            } else {
              emailSentResult = 'failed';
              console.error('[Success] Failed to send email:', emailResult.error);
            }
          } else {
            emailSentResult = 'already-sent';
            console.log('[Success] Email already sent, skipping duplicate');
          }
        }
      }
    }
  } catch (err: any) {
    console.error('[Success] Error in server-side email send:', err.message);
    emailSentResult = 'error';
  }
}
---

<PublicLayout title="Compra Realizada | 칄CLAT" description="Gracias por tu compra">
  {/* Clear cart on component mount */}
  <ClearCartOnSuccess client:load />
  
  <script>
    // Limpiar carrito despu칠s de pago exitoso
    // El cup칩n ya se limpi칩 de memoria autom치ticamente durante checkout
    if (typeof window !== 'undefined') {
      // Registrar en console
      const cartData = localStorage.getItem('eclat-cart:');
      
      console.log('[Success Page] Iniciando limpieza post-pago:', {
        hasCart: !!cartData,
        timestamp: new Date().toISOString()
      });

      let itemsCount = 0;
      let discountApplied = 0;

      // Limpiar carrito
      if (cartData) {
        try {
          const cart = JSON.parse(cartData);
          itemsCount = Object.keys(cart).length;
          console.log('[Success Page] Carrito vaciado - Items:', itemsCount);
        } catch (e) {
          console.warn('[Success Page] No se pudo parsear carrito');
        }
      }
      localStorage.removeItem('eclat-cart:');

      // Verificar que est치 limpio
      const cartAfter = localStorage.getItem('eclat-cart:');
      
      console.log('[Success Page] VERIFICACI칍N FINAL:', {
        cartLimpio: !cartAfter,
        timestamp: new Date().toISOString()
      });

      // Confirmar al servidor que se limpi칩 el carrito
      const orderId = new URLSearchParams(window.location.search).get('orderId');
      const email = new URLSearchParams(window.location.search).get('email');
      
      if (orderId) {
        fetch('/api/checkout/confirm-clear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            orderId,
            email,
            itemsCount,
            discountApplied
          })
        }).catch(err => console.warn('[Success Page] No se pudo confirmar limpieza:', err));
      }
    }
  </script>
  <div class="min-h-[80vh] flex items-center justify-center bg-[#faf9f7] py-16 px-4">
    <div class="max-w-lg w-full text-center">

      <!-- Icono animado -->
      <div class="relative mx-auto mb-8 w-24 h-24">
        <div class="absolute inset-0 rounded-full bg-rose-50 animate-ping opacity-30"></div>
        <div class="relative flex items-center justify-center w-24 h-24 rounded-full bg-gradient-to-br from-rose-100 to-pink-50 border border-rose-200 shadow-md">
          <svg class="h-11 w-11 text-rose-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
          </svg>
        </div>
      </div>

      <!-- T칤tulo -->
      <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight mb-2">춰Pedido confirmado!</h1>
      <p class="text-gray-500 text-sm mb-8">
        Gracias por tu compra en 칄CLAT Beauty.
        {email && (
          <span> Recibir치s un email en <strong class="text-gray-800">{email}</strong>.</span>
        )}
      </p>

      <!-- N칰mero de pedido -->
      {orderId && (
        <div class="mb-8 mx-auto max-w-xs">
          <div class="bg-white border border-gray-200 rounded-xl px-6 py-4 shadow-sm">
            <p class="text-[10px] text-gray-400 uppercase tracking-widest font-semibold mb-1">N칰mero de pedido</p>
            <p class="text-xl font-bold text-gray-900 font-mono tracking-wide" id="orderNumber">Cargando...</p>
          </div>
        </div>
      )}

      <script>
        if (typeof window !== 'undefined') {
          const el = document.getElementById('orderNumber');
          if (el) {
            const n = localStorage.getItem('eclat:lastOrderNumber');
            el.textContent = n ? `#${n}` : '#N/A';
          }
        }
      </script>

      <!-- Pasos que siguen -->
      <div class="mb-10 grid grid-cols-3 gap-4 text-center">
        <div class="flex flex-col items-center gap-2">
          <div class="w-10 h-10 rounded-full bg-rose-50 border border-rose-100 flex items-center justify-center">
            <svg class="w-5 h-5 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
          </div>
          <p class="text-[11px] text-gray-500 leading-tight">Email de<br/>confirmaci칩n</p>
        </div>
        <div class="flex flex-col items-center gap-2">
          <div class="w-10 h-10 rounded-full bg-rose-50 border border-rose-100 flex items-center justify-center">
            <svg class="w-5 h-5 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
            </svg>
          </div>
          <p class="text-[11px] text-gray-500 leading-tight">Preparaci칩n<br/>del pedido</p>
        </div>
        <div class="flex flex-col items-center gap-2">
          <div class="w-10 h-10 rounded-full bg-rose-50 border border-rose-100 flex items-center justify-center">
            <svg class="w-5 h-5 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"/>
            </svg>
          </div>
          <p class="text-[11px] text-gray-500 leading-tight">Entrega en<br/>tu domicilio</p>
        </div>
      </div>

      <!-- CTAs -->
      <div class="space-y-3">
        <a href="/mi-cuenta/pedidos" class="flex items-center justify-center gap-2 w-full bg-black text-white px-8 py-4 text-xs font-bold uppercase tracking-widest hover:bg-gray-900 transition-colors shadow-md">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          </svg>
          Ver mis pedidos
        </a>
        <a href="/" class="flex items-center justify-center gap-2 w-full border border-gray-200 bg-white text-gray-700 px-8 py-3.5 text-xs font-bold uppercase tracking-widest hover:bg-gray-50 transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"/>
          </svg>
          Seguir comprando
        </a>
      </div>

      <!-- Footer note -->
      <p class="mt-8 text-[11px] text-gray-400">
        쯅o has recibido el email? Revisa spam o <a href="/contacto" class="underline hover:text-gray-700 transition-colors">cont치ctanos</a>.
      </p>

    </div>
  </div>
</PublicLayout>
