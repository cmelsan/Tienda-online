---
export const prerender = false;
import AdminLayout from '@/layouts/AdminLayout.astro';
import { supabase } from '@/lib/supabase';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/admin/marcas');
}

// Fetch existing brand
const { data: brand, error: fetchError } = await supabase
  .from('brands')
  .select('*')
  .eq('id', id)
  .single();

if (fetchError || !brand) {
  return Astro.redirect('/admin/marcas');
}

let errorMsg = '';
let successMsg = '';

if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const name = formData.get("name")?.toString();
    const slug = formData.get("slug")?.toString();
    const description = formData.get("description")?.toString();
    const logo_url = formData.get("logo_url")?.toString();

    if (!name || !slug) {
      throw new Error("Nombre y Slug son obligatorios.");
    }

    const { error } = await supabase
      .from("brands")
      .update({
        name,
        slug,
        description,
        logo_url,
        updated_at: new Date().toISOString(),
      })
      .eq('id', id);

    if (error) throw error;

    return Astro.redirect("/admin/marcas");
  } catch (err: any) {
    errorMsg = err.message || "Error al actualizar la marca.";
  }
}
---

<AdminLayout title={`Editar Marca: ${brand.name}`}>
  <div class="mb-8">
    <a href="/admin/marcas" class="text-xs font-bold text-gray-400 hover:text-black uppercase tracking-wider transition-colors mb-4 block">
      ← Volver al listado
    </a>
    <h1 class="text-2xl font-bold text-black uppercase tracking-widest">Editar Marca</h1>
  </div>

  <div class="max-w-2xl">
    {errorMsg && (
      <div class="bg-red-50 text-red-600 p-4 text-sm font-medium mb-6">
        {errorMsg}
      </div>
    )}

    <form method="POST" class="space-y-8 bg-white p-8 border border-gray-200">
      
      <!-- Name -->
      <div>
        <label class="block text-xs font-bold text-gray-700 uppercase tracking-wider mb-2">
          Nombre de la Marca <span class="text-red-500">*</span>
        </label>
        <input
          type="text"
          name="name"
          value={brand.name}
          required
          class="w-full border-b border-gray-300 py-2 text-sm focus:border-black focus:outline-none transition-colors placeholder-gray-400 font-medium"
        />
      </div>

      <!-- Slug -->
      <div>
        <label class="block text-xs font-bold text-gray-700 uppercase tracking-wider mb-2">
          Slug (URL) <span class="text-red-500">*</span>
        </label>
        <input
          type="text"
          name="slug"
          value={brand.slug}
          required
          class="w-full border-b border-gray-300 py-2 text-sm focus:border-black focus:outline-none transition-colors placeholder-gray-400 font-mono text-gray-600"
        />
      </div>

      <!-- Description -->
      <div>
        <label class="block text-xs font-bold text-gray-700 uppercase tracking-wider mb-2">
          Descripción
        </label>
        <textarea
          name="description"
          rows="4"
          class="w-full border border-gray-300 p-3 text-sm focus:border-black focus:outline-none transition-colors placeholder-gray-400 resize-none bg-gray-50"
        >{brand.description}</textarea>
      </div>

       <!-- Logo URL -->
       <div>
        <label class="block text-xs font-bold text-gray-700 uppercase tracking-wider mb-2">
          URL del Logo
        </label>
        <input
          type="url"
          name="logo_url"
          value={brand.logo_url || ''}
          class="w-full border-b border-gray-300 py-2 text-sm focus:border-black focus:outline-none transition-colors placeholder-gray-400"
        />
      </div>

      <div class="pt-4 border-t border-gray-100 flex justify-end">
        <button
          type="submit"
          class="bg-black text-white px-8 py-4 text-xs font-bold uppercase tracking-widest hover:bg-gray-800 transition-colors"
        >
          Guardar Cambios
        </button>
      </div>

    </form>
  </div>
</AdminLayout>
