---
export const prerender = false;

import PublicLayout from '@/layouts/PublicLayout.astro';
---

<PublicLayout
  title="Carrito de Compra - ÉCLAT"
  description="Revisa tu carrito de compra"
>
  <div class="min-h-screen bg-[#faf9f7] py-12">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">

      <!-- Header -->
      <div class="mb-10 border-b border-gray-200 pb-6">
        <p class="text-[10px] font-bold uppercase tracking-[0.3em] text-rose-400 mb-2">ÉCLAT Beauty</p>
        <h1 class="text-3xl md:text-4xl font-light text-black">Tu Carrito</h1>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-[1fr_360px] gap-10">
        <!-- Cart items -->
        <div id="cart-container"></div>

        <!-- Summary panel -->
        <div id="summary-container"></div>
      </div>

    </div>
  </div>
</PublicLayout>

<script>
  import { cartItemsArray, appliedCoupon, applyCoupon, updateQuantity, removeFromCart, removeCoupon } from '@/stores/cart';
  import { formatPrice } from '@/lib/utils';
  import { addNotification } from '@/stores/notifications';

  // ── Handle return from Stripe without paying ──────────────────────────────────
  (async () => {
    const params = new URLSearchParams(window.location.search);
    if (params.get('canceled') === 'true') {
      const orderId = params.get('orderId');
      if (orderId) {
        try {
          await fetch(`/api/orders/delete-pending?orderId=${orderId}`, { method: 'DELETE' });
        } catch (_) {}
      }
      addNotification('Has vuelto al carrito. Tu pedido no se ha procesado.', 'info');
      window.history.replaceState({}, '', '/carrito');
    }
  })();

  const cartContainer   = document.getElementById('cart-container')!;
  const summaryContainer = document.getElementById('summary-container')!;

  // ── Helpers ───────────────────────────────────────────────────────────────────
  function getSubtotal() {
    return cartItemsArray.get().reduce((s, i) => s + i.product.price * i.quantity, 0);
  }
  function getTotal() {
    const coupon = appliedCoupon.get();
    const sub = getSubtotal();
    return coupon?.discount_amount ? Math.max(0, sub - coupon.discount_amount) : sub;
  }

  // ── Render ────────────────────────────────────────────────────────────────────
  function renderCart() {
    const items  = cartItemsArray.get();
    const coupon = appliedCoupon.get();

    // ── Empty state ───────────────────────────────────────────────────────────
    if (!items || items.length === 0) {
      cartContainer.innerHTML = `
        <div class="flex flex-col items-center justify-center py-24 text-center">
          <div class="w-16 h-16 rounded-full bg-rose-50 flex items-center justify-center mb-6">
            <svg class="w-7 h-7 text-rose-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
            </svg>
          </div>
          <p class="text-xl font-light text-black mb-2">Tu carrito está vacío</p>
          <p class="text-sm text-gray-400 mb-8">Explora nuestra colección y añade tus favoritos</p>
          <a href="/productos" class="inline-block border-b border-black text-black font-semibold text-xs uppercase tracking-widest pb-1 hover:text-rose-400 hover:border-rose-400 transition-colors">
            Explorar productos
          </a>
        </div>`;
      summaryContainer.innerHTML = '';
      return;
    }

    const subtotal = getSubtotal();
    const total    = getTotal();

    // ── Item list ─────────────────────────────────────────────────────────────
    cartContainer.innerHTML = `
      <div class="space-y-0">
        <!-- Column headers (desktop) -->
        <div class="hidden md:grid grid-cols-[1fr_120px_100px_40px] gap-4 text-[10px] font-bold uppercase tracking-widest text-gray-400 pb-3 border-b border-gray-200 mb-2">
          <span>Producto</span>
          <span class="text-center">Cantidad</span>
          <span class="text-right">Precio</span>
          <span></span>
        </div>

        ${items.map(item => {
          const lineTotal = item.product.price * item.quantity;
          const img = item.product.images?.[0] || '/placeholder-product.jpg';
          return `
          <div class="grid grid-cols-[auto_1fr] md:grid-cols-[1fr_120px_100px_40px] gap-4 items-center py-5 border-b border-gray-100" data-item-id="${item.product.id}">
            <!-- Image + name (spans 1st col on desktop, takes full row on mobile) -->
            <div class="flex items-center gap-4 col-span-2 md:col-span-1">
              <a href="/productos/${item.product.slug}" class="flex-shrink-0 w-20 h-20 bg-white border border-gray-100 overflow-hidden">
                <img src="${img}" alt="${item.product.name}" class="w-full h-full object-cover mix-blend-multiply" loading="lazy"/>
              </a>
              <div class="min-w-0">
                <p class="text-xs font-bold uppercase tracking-wide text-black leading-tight mb-1 line-clamp-2">${item.product.name}</p>
                <p class="text-[10px] text-gray-400">Ref: ${item.product.slug}</p>
              </div>
            </div>

            <!-- Quantity stepper -->
            <div class="flex items-center justify-center md:justify-center">
              <div class="flex items-center border border-gray-200 bg-white">
                <button
                  class="qty-btn w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-50 transition-colors text-lg leading-none select-none"
                  data-id="${item.product.id}" data-qty="${item.quantity - 1}"
                  aria-label="Disminuir cantidad"
                >−</button>
                <span class="w-8 h-8 flex items-center justify-center text-sm font-bold text-black border-x border-gray-200">${item.quantity}</span>
                <button
                  class="qty-btn w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-50 transition-colors text-lg leading-none select-none"
                  data-id="${item.product.id}" data-qty="${item.quantity + 1}"
                  aria-label="Aumentar cantidad"
                >+</button>
              </div>
            </div>

            <!-- Price -->
            <div class="flex flex-col items-end justify-center text-right">
              <p class="text-sm font-bold text-black">${formatPrice(lineTotal)}</p>
              ${item.quantity > 1 ? `<p class="text-[10px] text-gray-400">${formatPrice(item.product.price)} / ud.</p>` : ''}
            </div>

            <!-- Delete -->
            <div class="flex items-center justify-center md:justify-end">
              <button
                class="remove-btn p-1.5 rounded-full text-gray-300 hover:text-rose-500 hover:bg-rose-50 transition-all"
                data-id="${item.product.id}"
                aria-label="Eliminar producto"
                title="Eliminar"
              >
                <svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
          </div>`;
        }).join('')}
      </div>

      <!-- Continue shopping -->
      <div class="mt-6">
        <a href="/productos" class="inline-flex items-center gap-2 text-xs text-gray-400 hover:text-black transition-colors uppercase tracking-widest font-semibold">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          Seguir comprando
        </a>
      </div>`;

    // ── Summary panel ─────────────────────────────────────────────────────────
    summaryContainer.innerHTML = `
      <div class="space-y-4 lg:sticky lg:top-6">

        <!-- Coupon -->
        <div class="bg-white border border-gray-100 p-5">
          <p class="text-[10px] font-bold uppercase tracking-widest text-gray-500 mb-3">Código de descuento</p>
          ${coupon?.code ? `
            <div class="flex items-center justify-between bg-rose-50 border border-rose-200 px-3 py-2 rounded">
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-rose-500" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"/>
                </svg>
                <span class="text-sm font-bold text-rose-700">${coupon.code}</span>
              </div>
              <button id="remove-coupon-btn" class="text-xs text-rose-400 hover:text-rose-700 transition-colors font-semibold">✕ Quitar</button>
            </div>
          ` : `
            <div class="flex gap-2">
              <input
                type="text"
                id="coupon-input"
                placeholder="Tu código"
                class="flex-1 border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:border-black transition-colors uppercase"
              />
              <button id="apply-coupon-btn" class="px-4 py-2 bg-black text-white text-xs font-bold uppercase tracking-wide hover:bg-gray-800 transition-colors whitespace-nowrap">
                Aplicar
              </button>
            </div>
            <p id="coupon-msg" class="text-xs mt-2 min-h-[1rem]"></p>
          `}
        </div>

        <!-- Order summary -->
        <div class="bg-white border border-gray-100 p-5">
          <p class="text-[10px] font-bold uppercase tracking-widest text-gray-500 mb-4">Resumen</p>

          <div class="space-y-2 text-sm pb-4 border-b border-gray-100">
            <div class="flex justify-between text-gray-500">
              <span>Subtotal (${items.length} ${items.length === 1 ? 'artículo' : 'artículos'})</span>
              <span class="font-semibold text-black">${formatPrice(subtotal)}</span>
            </div>
            ${coupon?.code && coupon.discount_amount > 0 ? `
              <div class="flex justify-between text-rose-500">
                <span>Descuento ${coupon.code}</span>
                <span class="font-semibold">−${formatPrice(coupon.discount_amount)}</span>
              </div>
            ` : ''}
            <div class="flex justify-between text-gray-400 text-xs">
              <span>Envío</span>
              <span class="font-medium text-green-600">GRATIS</span>
            </div>
          </div>

          <div class="flex justify-between items-baseline pt-4 mb-6">
            <span class="text-[10px] font-bold uppercase tracking-widest text-gray-600">Total</span>
            <span class="text-2xl font-light text-black">${formatPrice(total)}</span>
          </div>

          <!-- CTA -->
          <a href="/checkout" class="block w-full py-3.5 bg-black text-white text-center text-xs font-bold uppercase tracking-widest hover:bg-gray-900 transition-colors">
            Finalizar compra
          </a>

          <!-- Trust badges -->
          <div class="mt-5 pt-5 border-t border-gray-100 grid grid-cols-3 gap-3 text-center">
            <div>
              <svg class="w-5 h-5 mx-auto mb-1 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
              </svg>
              <p class="text-[9px] text-gray-400 leading-tight">Pago<br>seguro</p>
            </div>
            <div>
              <svg class="w-5 h-5 mx-auto mb-1 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/>
              </svg>
              <p class="text-[9px] text-gray-400 leading-tight">Envío<br>24–48h</p>
            </div>
            <div>
              <svg class="w-5 h-5 mx-auto mb-1 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
              <p class="text-[9px] text-gray-400 leading-tight">Cambios<br>30 días</p>
            </div>
          </div>
        </div>
      </div>`;

    // ── Attach event listeners after each render ───────────────────────────────

    // Quantity buttons
    document.querySelectorAll<HTMLButtonElement>('.qty-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id  = btn.dataset.id!;
        const qty = parseInt(btn.dataset.qty!, 10);
        try {
          updateQuantity(id, qty);
        } catch (err: any) {
          addNotification(err?.message || 'Error al cambiar cantidad', 'error');
        }
      });
    });

    // Remove buttons
    document.querySelectorAll<HTMLButtonElement>('.remove-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        removeFromCart(btn.dataset.id!);
      });
    });

    // Remove coupon
    document.getElementById('remove-coupon-btn')?.addEventListener('click', () => {
      removeCoupon();
    });

    // Apply coupon
    document.getElementById('apply-coupon-btn')?.addEventListener('click', () => {
      applyCartCoupon();
    });
    document.getElementById('coupon-input')?.addEventListener('keydown', (e: Event) => {
      if ((e as KeyboardEvent).key === 'Enter') applyCartCoupon();
    });
  }

  // ── Coupon logic ──────────────────────────────────────────────────────────────
  async function applyCartCoupon() {
    const input = document.getElementById('coupon-input') as HTMLInputElement | null;
    const msgEl = document.getElementById('coupon-msg');
    if (!input?.value.trim()) {
      if (msgEl) { msgEl.textContent = 'Introduce un código'; msgEl.className = 'text-xs mt-2 text-red-500'; }
      return;
    }
    if (msgEl) { msgEl.textContent = 'Validando...'; msgEl.className = 'text-xs mt-2 text-gray-400'; }

    const items    = cartItemsArray.get();
    const subtotal = items.reduce((s, i) => s + i.product.price * i.quantity, 0);

    try {
      const res  = await fetch('/api/checkout/validate-coupon', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code: input.value.toUpperCase(), totalAmount: subtotal }),
      });
      const data = await res.json();
      if (data.valid) {
        applyCoupon({
          code:           data.coupon.code,
          id:             data.coupon.id,
          discount_value: data.coupon.discount_value,
          discount_type:  data.coupon.discount_type,
          discount_amount:data.coupon.discount_amount,
        });
        addNotification(`Cupón ${data.coupon.code} aplicado`, 'success');
      } else {
        if (msgEl) { msgEl.textContent = data.error || 'Código inválido'; msgEl.className = 'text-xs mt-2 text-red-500'; }
      }
    } catch {
      if (msgEl) { msgEl.textContent = 'Error de conexión'; msgEl.className = 'text-xs mt-2 text-red-500'; }
    }
  }

  // ── Reactive subscriptions ────────────────────────────────────────────────────
  cartItemsArray.subscribe(() => renderCart());
  appliedCoupon.subscribe(() => renderCart());

  // Initial render
  renderCart();
</script>

</PublicLayout>
