---
import PublicLayout from '@/layouts/PublicLayout.astro';
import ProductGallery from '@/components/product/ProductGallery.astro';
import ProductCard from '@/components/product/ProductCard.astro';
import AddToCartButton from '@/components/islands/AddToCartButton';
import { supabase } from '@/lib/supabase';
import { formatPrice, getStockLabel } from '@/lib/utils';

export async function getStaticPaths() {
  const { data: products } = await supabase
    .from('products')
    .select('slug');

  return products?.map((product) => ({
    params: { slug: product.slug },
  })) || [];
}

const { slug } = Astro.params;

// Fetch product data
const { data: product } = await supabase
  .from('products')
  .select('*, category:categories(*)')
  .eq('slug', slug)
  .single();

if (!product) {
  return Astro.redirect('/404');
}

// Map category slug to fallback image for related products
const getFallbackImage = (categorySlug: string) => {
  return `/assets/products/${
    categorySlug === 'maquillaje' ? 'makeup-default.png' :
    categorySlug === 'cabello' ? 'hair-default.png' :
    categorySlug === 'cuerpo' ? 'body-default.png' :
    categorySlug === 'perfumes' ? 'perfume-default.png' :
    'makeup-default.png'
  }`;
};

// Fetch related products
const { data: relatedProducts } = await supabase
  .from('products')
  .select('*')
  .eq('category_id', product.category_id)
  .neq('id', product.id)
  .limit(4);
---

<PublicLayout
  title={`${product.name} - ÉCLAT`}
  description={product.description}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 lg:py-20">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 lg:gap-24">
      
      <!-- Left Column: Gallery (Sticky) -->
      <div class="lg:col-span-7">
        <div class="sticky top-32">
          <ProductGallery images={product.images} productName={product.name} />
        </div>
      </div>

      <!-- Right Column: Info (Sticky) -->
      <div class="lg:col-span-5 relative">
        <div class="sticky top-32 space-y-8">
          <!-- Header -->
          <div class="border-b border-black pb-8">
            <a
              href={`/categoria/${product.category.slug}`}
              class="block text-xs font-bold text-black uppercase tracking-[0.2em] mb-4 hover:underline"
            >
              {product.category.name}
            </a>
            <h1 class="text-4xl lg:text-5xl font-serif font-medium text-black mb-4 leading-tight">
              {product.name}
            </h1>
            <p class="text-2xl font-medium text-black">
              {formatPrice(product.price)}
            </p>
          </div>

          <!-- Description Short -->
          <p class="text-base text-black/80 leading-relaxed font-light">
            {product.description}
          </p>

          <!-- Shade Selector (Mock) -->
          <div>
            <span class="text-xs font-bold text-black uppercase tracking-wider block mb-3">Tono Seleccionado</span>
            <div class="flex flex-wrap gap-2">
              <button class="w-8 h-8 rounded-full border-2 border-black bg-[#d4a373] ring-2 ring-offset-2 ring-transparent transition-all" aria-label="Tono 1"></button>
              <button class="w-8 h-8 rounded-full border border-black/10 bg-[#e0b589] hover:border-black transition-all" aria-label="Tono 2"></button>
              <button class="w-8 h-8 rounded-full border border-black/10 bg-[#8d5524] hover:border-black transition-all" aria-label="Tono 3"></button>
            </div>
          </div>

          <!-- Add to Cart -->
          <div class="pt-4">
             <div class="bg-black text-white p-6 md:p-8 rounded-none shadow-2xl">
                <AddToCartButton product={product} client:load />
             </div>
             <div class="mt-4 flex items-center justify-center space-x-2 text-xs font-bold uppercase tracking-wider text-black">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                <span>Envío Gratis en pedidos +39€</span>
             </div>
          </div>

          <!-- Accordions -->
          <div class="border-t border-black pt-2 space-y-0">
            <details class="group border-b border-gray-200 cursor-pointer">
              <summary class="flex items-center justify-between py-5 list-none">
                <span class="text-sm font-bold uppercase tracking-wider text-black">Descripción</span>
                <span class="text-xl transition-transform group-open:rotate-45 font-light">+</span>
              </summary>
              <div class="pb-6 text-sm text-gray-600 leading-relaxed">
                <p>Formula ligera y de larga duración que proporciona un acabado impecable. Enriquecida con ingredientes nutritivos para cuidar tu piel mientras realzas tu belleza natural.</p>
              </div>
            </details>
            <details class="group border-b border-gray-200 cursor-pointer">
              <summary class="flex items-center justify-between py-5 list-none">
                <span class="text-sm font-bold uppercase tracking-wider text-black">Ingredientes</span>
                <span class="text-xl transition-transform group-open:rotate-45 font-light">+</span>
              </summary>
              <div class="pb-6 text-sm text-gray-600 leading-relaxed">
                <p>Aqua, Glycerin, Dimethicone, Squalane, Vitamin E, Hyaluronic Acid.</p>
              </div>
            </details>
            <details class="group border-b border-gray-200 cursor-pointer">
              <summary class="flex items-center justify-between py-5 list-none">
                <span class="text-sm font-bold uppercase tracking-wider text-black">Envío y Devoluciones</span>
                <span class="text-xl transition-transform group-open:rotate-45 font-light">+</span>
              </summary>
              <div class="pb-6 text-sm text-gray-600 leading-relaxed">
                <p>Envío estándar gratuito en pedidos superiores a 39€. Devoluciones gratuitas en un plazo de 30 días.</p>
              </div>
            </details>
          </div>
        </div>
      </div>
    </div>

    <!-- Related Products -->
    {relatedProducts && relatedProducts.length > 0 && (
      <section class="mt-32 border-t border-black pt-20">
        <h2 class="text-3xl font-serif font-medium text-black mb-12 text-center uppercase tracking-tight">
          Te Podría Interesar
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
          {relatedProducts.map((relatedProduct) => (
            <ProductCard 
              product={relatedProduct} 
              fallbackImage={getFallbackImage(product.category.slug)}
            />
          ))}
        </div>
      </section>
    )}
  </div>
</PublicLayout>
