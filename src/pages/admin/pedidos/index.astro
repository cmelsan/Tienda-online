---
export const prerender = false;

import AdminLayout from '@/layouts/AdminLayout.astro';
import AdminOrdersTable from '@/components/admin/AdminOrdersTable';
import { supabase } from '@/lib/supabase';

// Fetch orders with items
const { data: orders, error } = await supabase
  .from('orders')
  .select(`
    id,
    order_number,
    created_at,
    status,
    total_amount,
    user_id,
    guest_email,
    order_items (
      id,
      quantity,
      price_at_purchase,
      product:product_id (
        id,
        name,
        stock
      )
    ),
    order_status_history!order_status_history_order_id_fkey (
      notes
    )
  `)
  .in('status', ['paid', 'shipped', 'delivered', 'cancelled', 'return_requested', 'returned', 'refunded', 'partially_returned', 'partially_refunded'])
  .order('created_at', { ascending: false });

if (error) {
  console.error('Error fetching orders:', error);
}

const orderList = (orders || []).map((o: any) => ({
  ...o,
  stockIssue: (o.order_status_history || []).some((h: any) => h.notes?.startsWith('STOCK_ISSUE:')),
}));

// Stats por estado
const totalOrders = orderList.filter(o => o.status !== 'cancelled').length;
const pendingOrders = orderList.filter(o => o.status === 'paid').length;
const shippedOrders = orderList.filter(o => o.status === 'shipped').length;
const deliveredOrders = orderList.filter(o => o.status === 'delivered').length;
const cancelledOrders = orderList.filter(o => o.status === 'cancelled').length;
const totalRevenue = orderList
  .filter(o => !['cancelled', 'refunded'].includes(o.status))
  .reduce((sum, o) => sum + (o.total_amount || 0), 0);
---

<AdminLayout title="Pedidos">
  <!-- Header -->
  <div class="mb-8">
    <div class="flex items-end justify-between mb-6">
      <div>
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-1">Ventas</p>
        <p class="text-xs text-gray-400">Gestiona pedidos y devoluciones</p>
      </div>
      <p class="text-[10px] text-gray-400 uppercase tracking-widest">
        {new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
      </p>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-2 lg:grid-cols-6 gap-3">
      <div class="bg-black text-white p-4 col-span-2 lg:col-span-1">
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2">Total</p>
        <p class="text-3xl font-black">{totalOrders}</p>
        <div class="w-6 h-0.5 bg-pink-500 mt-2"></div>
      </div>
      <div class="bg-white border border-gray-200 p-4">
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2">Pendientes</p>
        <p class="text-2xl font-black text-black">{pendingOrders}</p>
      </div>
      <div class="bg-white border border-gray-200 p-4">
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2">Enviados</p>
        <p class="text-2xl font-black text-black">{shippedOrders}</p>
      </div>
      <div class="bg-white border border-gray-200 p-4">
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2">Entregados</p>
        <p class="text-2xl font-black text-black">{deliveredOrders}</p>
      </div>
      <div class="bg-white border border-gray-200 p-4">
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2">Cancelados</p>
        <p class="text-2xl font-black text-black">{cancelledOrders}</p>
      </div>
      <div class="bg-white border border-gray-200 p-4">
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2">Ingresos</p>
        <p class="text-xl font-black text-black leading-tight">
          {new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(totalRevenue / 100)}
        </p>
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <AdminOrdersTable client:load orders={orderList as any} />
</AdminLayout>
