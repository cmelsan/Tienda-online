---
export const prerender = false; // SSR

import AdminLayout from '@/layouts/AdminLayout.astro';
import Input from '@/components/ui/Input.astro';
import Button from '@/components/ui/Button.astro';
import ImageUploader from '@/components/admin/ImageUploader';
import { supabase } from '@/lib/supabase';

// Fetch categories for dropdown
const { data: categories } = await supabase
  .from('categories')
  .select('*')
  .order('name');

// Fetch brands for dropdown
const { data: brands } = await supabase
  .from('brands')
  .select('*')
  .order('name');

// Fetch subcategories
const { data: subcategories } = await supabase
  .from('subcategories')
  .select('*')
  .order('name');
---

<AdminLayout title="Nuevo Producto">
  <div class="max-w-4xl" x-data={`{ selectedCategory: '' }`}>
    <div class="mb-8 flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-black uppercase tracking-wider mb-2">Crear Nuevo Producto</h1>
        <p class="text-xs text-gray-500 uppercase tracking-wide">Añade un nuevo item al inventario</p>
      </div>
      <a
        href="/admin/productos"
        class="text-xs font-bold text-gray-500 hover:text-black uppercase tracking-wider flex items-center space-x-2"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        <span>Volver</span>
      </a>
    </div>

    <div id="errorMessage" class="mb-8 p-4 bg-rose-50 border border-rose-200 text-rose-600 text-xs font-bold uppercase tracking-wide hidden"></div>

    <form id="productForm" class="bg-white border border-gray-200 p-8 shadow-sm space-y-8">
      <!-- Basic Info -->
      <div class="space-y-6">
        <h3 class="text-sm font-bold text-black uppercase border-b border-gray-100 pb-2">Información Básica</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <Input
            label="Nombre del Producto"
            name="name"
            type="text"
            placeholder="EJ: BASE DE MAQUILLAJE LUMINOSA"
            required
            class="uppercase"
          />
          
          <div class="space-y-2">
            <label for="category_id" class="block text-xs font-bold text-gray-700 uppercase tracking-wider">
              Categoría <span class="text-rose-500">*</span>
            </label>
            <select
              id="category_id"
              name="category_id"
              x-model="selectedCategory"
              required
              class="w-full border-b border-gray-300 py-2 text-sm focus:border-black focus:outline-none transition-colors bg-white text-black uppercase rounded-none"
            >
              <option value="">SELECCIONAR CATEGORÍA</option>
              {categories?.map((category) => (
                <option value={category.id}>{category.name}</option>
              ))}
            </select>
          </div>

          <!-- SUBCATEGORY SELECTOR -->
          <div class="space-y-2" x-show="selectedCategory" style="display: none;">
             <label for="subcategory_id" class="block text-xs font-bold text-gray-700 uppercase tracking-wider">
               Subcategoría
             </label>
             <select
               id="subcategory_id"
               name="subcategory_id"
               class="w-full border-b border-gray-300 py-2 text-sm focus:border-black focus:outline-none transition-colors bg-white text-black uppercase rounded-none"
             >
               <option value="">Seleccionar Subcategoría</option>
               {subcategories?.map(sub => (
                   <option value={sub.id} data-cat={sub.category_id} x-show={`'${sub.category_id}' == selectedCategory`}>
                      {sub.name}
                   </option>
               ))}
             </select>
          </div>

          <div class="space-y-2">
            <label for="brand_id" class="block text-xs font-bold text-gray-700 uppercase tracking-wider">
              Marca
            </label>
            <select
              id="brand_id"
              name="brand_id"
              class="w-full border-b border-gray-300 py-2 text-sm focus:border-black focus:outline-none transition-colors bg-white text-black uppercase rounded-none"
            >
              <option value="">SIN MARCA / GENÉRICO</option>
              {brands?.map((brand) => (
                <option value={brand.id}>{brand.name}</option>
              ))}
            </select>
          </div>
        </div>

        <div class="space-y-2">
          <label for="description" class="block text-xs font-bold text-gray-700 uppercase tracking-wider">
            Descripción <span class="text-rose-500">*</span>
          </label>
          <textarea
            id="description"
            name="description"
            rows="6"
            required
            placeholder="Descripción detallada del producto..."
            class="w-full border border-gray-300 p-3 text-sm focus:border-black focus:ring-0 focus:outline-none transition-colors placeholder-gray-400 rounded-none"
          ></textarea>
        </div>
      </div>

      <!-- Price & Stock -->
      <div class="space-y-6">
        <h3 class="text-sm font-bold text-black uppercase border-b border-gray-100 pb-2">Precio y Stock</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <Input
            label="Precio (EUR)"
            name="price"
            type="number"
            step="0.01"
            min="0"
            placeholder="0.00"
            required
          />

          <Input
            label="Stock Disponible"
            name="stock"
            type="number"
            min="0"
            placeholder="0"
            required
          />
        </div>
      </div>

      <!-- Images -->
      <div class="space-y-6">
        <h3 class="text-sm font-bold text-black uppercase border-b border-gray-100 pb-2">Imágenes</h3>
        
        <ImageUploader client:load onImagesChange={() => {}} />
        
        <p class="text-[10px] text-gray-500 uppercase tracking-wide">
          ✓ Las imágenes se suben automáticamente a Cloudinary<br/>
          ✓ Se guardarán como URLs en la base de datos<br/>
          ✓ Máximo 5 imágenes por producto
        </p>
      </div>

      <!-- Actions -->
      <div class="pt-6 border-t border-gray-100 flex items-center justify-end space-x-4">
        <a
          href="/admin/productos"
          class="px-6 py-3 text-xs font-bold text-gray-500 hover:text-black uppercase tracking-widest transition-colors"
        >
          Cancelar
        </a>
        <Button type="submit" variant="primary" size="lg" class="bg-black text-white hover:bg-gray-900 uppercase tracking-widest text-xs font-bold px-8 py-3 rounded-none">
          Guardar Producto
        </Button>
      </div>
    </form>
  </div>
</AdminLayout>

<script>
document.getElementById('productForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const formData = new FormData(e.target);
  const imagesField = formData.get('images')?.toString() || '';
  const images = imagesField.split('\n').filter(img => img.trim());
  
  const priceInEuros = parseFloat(formData.get('price') || '0');
  const priceInCents = Math.round(priceInEuros * 100);
  
  const data = {
    name: formData.get('name'),
    description: formData.get('description'),
    price: priceInCents,
    stock: parseInt(formData.get('stock') || '0'),
    category_id: formData.get('category_id'),
    subcategory_id: formData.get('subcategory_id') || null,
    brand_id: formData.get('brand_id') || null,
    images: images
  };
  
  console.log('Enviando producto:', data);
  
  try {
    const response = await fetch('/api/admin/products', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (response.ok) {
      console.log('Producto creado:', result);
      window.location.href = '/admin/productos';
    } else {
      console.error('Error:', result);
      const errorDiv = document.getElementById('errorMessage');
      if (errorDiv) {
        errorDiv.textContent = result.error || 'Error creando producto';
        errorDiv.style.display = 'block';
      }
    }
  } catch (err) {
    console.error('Error en la solicitud:', err);
    const errorDiv = document.getElementById('errorMessage');
    if (errorDiv) {
      errorDiv.textContent = 'Error al procesar la solicitud: ' + err.message;
      errorDiv.style.display = 'block';
    }
  }
});
</script>
