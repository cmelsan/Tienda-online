---
import PublicLayout from '@/layouts/PublicLayout.astro';
import { supabase } from '@/lib/supabase';
import { formatPrice } from '@/lib/utils';
import WishlistButton from '@/components/islands/WishlistButton';
import ProductAddToCart from '@/components/islands/ProductAddToCart';

// Fetch all products
const { data: dbProducts } = await supabase
  .from('products')
  .select('*, brand:brands(name, slug), category:categories(id, name, slug)')
  .order('created_at', { ascending: false });

// Fetch brands for sidebar
const { data: brandsList } = await supabase
  .from('brands')
  .select('*')
  .order('name');

// Get URL params for initial filter
const initialBrandSlug = Astro.url.searchParams.get('marca') || '';

const products = dbProducts?.map(p => ({
    ...p,
    brandName: p.brand?.name || 'Genérico',
    brandSlug: p.brand?.slug || '',
    categoryId: String(p.category_id || ''),
    categoryName: p.category?.name || '',
    isPromo: !!(p.is_flash_sale),
    isExclusive: false,
    originalPrice: p.is_flash_sale && p.flash_sale_discount
        ? Math.round(p.price / (1 - p.flash_sale_discount / 100))
        : null,
})) || [];

// Fetch categories for filter
const { data: categories } = await supabase
  .from('categories')
  .select('*')
  .order('name');

const allPrices = products.map(p => p.price).filter(Boolean);
const priceMin = allPrices.length ? Math.floor(Math.min(...allPrices)) : 0;
const priceMax = allPrices.length ? Math.ceil(Math.max(...allPrices)) : 1000;
---

<PublicLayout
  title="Productos - ÉCLAT"
  description="Explora nuestra colección completa de productos de belleza premium."
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Breadcrumb -->
    <nav class="text-sm text-gray-500 mb-8">
        <a href="/" class="hover:text-black">Página de inicio</a> / <span class="text-black font-bold">Todos los productos</span>
    </nav>

    <!-- Top Categories Visual Navigation -->
    <div class="flex flex-wrap justify-center gap-4 mb-12 border-b border-gray-200 pb-8">
        <button
          class="cat-top-btn px-6 py-3 border border-black font-bold text-xs uppercase hover:bg-black hover:text-white transition-colors tracking-widest bg-black text-white"
          data-cat-id="all"
        >
          Ver todos
        </button>
        {categories?.map((cat) => (
             <button
               class="cat-top-btn px-6 py-3 border border-black font-bold text-xs uppercase hover:bg-black hover:text-white transition-colors tracking-widest"
               data-cat-id={cat.id}
             >
                {cat.name}
             </button>
        ))}
    </div>

    <div class="flex flex-col lg:flex-row">
      <!-- Sidebar Filters -->
      <aside id="sidebar-filters" class="w-full lg:w-64 pr-0 lg:pr-8 mb-8 lg:mb-0 hidden md:block">
         <div id="toggle-sidebar-btn" class="border-b border-gray-200 pb-4 mb-6 flex justify-between items-center cursor-pointer group">
            <span id="toggle-sidebar-label" class="font-bold text-sm uppercase tracking-widest group-hover:text-gray-600">Ocultar Filtros</span>
            <svg id="toggle-sidebar-icon" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
         </div>

         <div id="sidebar-content">
         <!-- Categoría Filter -->
         <div class="mb-6">
            <h3 id="toggle-cat-btn" class="font-bold text-sm uppercase mb-4 flex justify-between cursor-pointer">
                Categoría
                <svg id="cat-arrow" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </h3>
            <div id="cat-section" class="pl-2 space-y-2 mt-2">
                <button class="cat-btn block text-sm text-left font-bold text-beauty-red hover:text-black" data-cat-id="all">
                    Ver todos
                </button>
                {categories?.map((cat) => (
                     <button
                       class="cat-btn block text-sm text-left text-gray-600 hover:text-black capitalize"
                       data-cat-id={cat.id}
                     >
                        {cat.name}
                     </button>
                ))}
            </div>
         </div>

         <!-- Marcas Filter -->
         <div class="mb-6">
            <h3 id="toggle-brand-btn" class="font-bold text-sm uppercase mb-4 flex justify-between cursor-pointer">
                Marcas
                <svg id="brand-arrow" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </h3>
            <div id="brand-section">
                <div class="relative mb-4">
                    <input
                      type="text"
                      id="brand-search"
                      placeholder="Buscar una marca"
                      class="w-full border-b border-black py-2 pl-0 pr-8 text-sm focus:outline-none focus:border-beauty-red placeholder-gray-400 italic font-sans"
                    />
                    <svg class="w-4 h-4 absolute right-0 top-3 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </div>
                <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                    {brandsList?.map(brand => (
                        <label class="brand-label flex items-center space-x-3 cursor-pointer group" data-brand-name={brand.name.toLowerCase()}>
                             <input
                                type="checkbox"
                                class="brand-checkbox w-5 h-5 border-2 border-gray-300 rounded-none checked:bg-black checked:border-black focus:ring-0 transition-colors"
                                data-brand-slug={brand.slug}
                                checked={initialBrandSlug === brand.slug}
                             />
                             <span class="text-sm text-black group-hover:underline">{brand.name}</span>
                        </label>
                    ))}
                </div>
            </div>
         </div>

         <!-- Precio Filter -->
         <div class="mb-6">
            <h3 id="toggle-price-btn" class="font-bold text-sm uppercase mb-4 flex justify-between cursor-pointer">
                Precio
                <svg id="price-arrow" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </h3>
            <div id="price-section" class="space-y-4">
                <div class="flex justify-between text-xs font-bold text-gray-600">
                    <span id="price-min-label">{priceMin}€</span>
                    <span id="price-max-label">{priceMax}€</span>
                </div>
                <input
                  type="range"
                  id="price-range-min"
                  min={priceMin}
                  max={priceMax}
                  value={priceMin}
                  class="w-full accent-black h-0.5 cursor-pointer"
                />
                <input
                  type="range"
                  id="price-range-max"
                  min={priceMin}
                  max={priceMax}
                  value={priceMax}
                  class="w-full accent-black h-0.5 cursor-pointer"
                />
                <div class="flex gap-2">
                    <div class="flex-1 border border-gray-300 px-2 py-1 flex items-center gap-1">
                        <span class="text-xs text-gray-400">€</span>
                        <input type="number" id="price-input-min" value={priceMin} min={priceMin} max={priceMax} class="w-full text-xs focus:outline-none" />
                    </div>
                    <div class="flex-1 border border-gray-300 px-2 py-1 flex items-center gap-1">
                        <span class="text-xs text-gray-400">€</span>
                        <input type="number" id="price-input-max" value={priceMax} min={priceMin} max={priceMax} class="w-full text-xs focus:outline-none" />
                    </div>
                </div>
            </div>
         </div>
         </div>
      </aside>

      <!-- Main Grid -->
      <div class="flex-1">
         <div class="mb-6 flex justify-between items-center">
            <span class="text-sm font-medium" id="product-count">{products.length} Productos</span>
            <div class="flex items-center gap-2 text-sm">
                <span class="text-gray-500">Ordenar por:</span>
                <select id="sort-select" class="border-none bg-transparent font-bold focus:ring-0 cursor-pointer">
                    <option value="default">Recomendados</option>
                    <option value="price-asc">Precio: Menor a Mayor</option>
                    <option value="price-desc">Precio: Mayor a Menor</option>
                </select>
            </div>
         </div>

         <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6" id="product-grid">
            {products.map((product) => (
                <div
                  class="product-card group flex flex-col h-full relative"
                  data-brand-slug={product.brandSlug}
                  data-category-id={product.categoryId}
                  data-price={product.price}
                >
                    <!-- Badges -->
                    <div class="absolute top-2 left-2 z-10 flex flex-col gap-1">
                        {product.isPromo && (
                           <span class="bg-beauty-red text-white text-[10px] font-bold uppercase px-2 py-1 tracking-wider">Promo</span>
                        )}
                        {product.isExclusive && (
                           <span class="bg-black text-white text-[10px] font-bold uppercase px-2 py-1 tracking-wider">Solo en Éclat</span>
                        )}
                    </div>

                    <!-- Wishlist Button Island -->
                    <div class="absolute top-2 right-2 z-10">
                      <WishlistButton client:load productId={product.id} productName={product.name} />
                    </div>

                     <!-- Image -->
                    <a href={`/productos/${product.slug}`} class="block relative aspect-square mb-4 bg-gray-50 overflow-hidden">
                       <img
                         src={product.images?.[0]}
                         alt={product.name}
                         class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                         loading="lazy"
                       />
                    </a>

                    <!-- Info -->
                    <div class="flex-1 flex flex-col text-center px-2">
                        <div class="mb-1">
                            <span class="font-bold text-xs uppercase tracking-widest text-black">{product.brandName}</span>
                        </div>
                        <h3 class="font-bold text-sm text-black uppercase mb-1 line-clamp-2 min-h-[40px]">
                            <a href={`/productos/${product.slug}`}>{product.name}</a>
                        </h3>
                        <p class="text-xs text-gray-500 mb-2 line-clamp-1">{product.description}</p>

                        <!-- Price -->
                        <div class="mt-auto mb-3">
                            {product.isPromo && product.originalPrice ? (
                                <div class="flex flex-col items-center gap-0.5">
                                    <span class="font-bold text-base text-red-700">{formatPrice(product.price)}</span>
                                    <span class="text-xs text-gray-500 line-through">Precio original: {formatPrice(product.originalPrice)}</span>
                                </div>
                            ) : (
                                <span class="font-bold text-base text-black">{formatPrice(product.price)}</span>
                            )}
                        </div>
                    </div>

                    <!-- Add to Cart Button Island -->
                    <ProductAddToCart
                        client:load
                        productId={product.id}
                        productName={product.name}
                        price={product.price}
                        image={product.images?.[0]}
                        slug={product.slug}
                    />
                </div>
            ))}
         </div>

         <!-- Empty state -->
         <div id="empty-state" class="hidden py-20 text-center">
           <p class="text-sm font-bold uppercase tracking-widest text-gray-400">Sin productos para los filtros seleccionados</p>
         </div>
      </div>
    </div>
  </div>
</PublicLayout>

<style>
  .custom-scrollbar::-webkit-scrollbar { width: 4px; }
  .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: #000; }

  .product-card.hidden { display: none; }

  .cat-btn.active-cat { color: #e11d48; font-weight: 700; }
  .cat-top-btn.active-cat-top { background: black !important; color: white !important; }
</style>

<script define:vars={{ initialBrandSlug, priceMin, priceMax }}>
  let selectedCategory = 'all';
  let selectedBrands = initialBrandSlug ? [initialBrandSlug] : [];
  let currentMinPrice = priceMin;
  let currentMaxPrice = priceMax;

  const cards = document.querySelectorAll('.product-card');
  const countEl = document.getElementById('product-count');
  const emptyState = document.getElementById('empty-state');
  const productGrid = document.getElementById('product-grid');

  function applyFilters() {
    let visible = 0;
    cards.forEach(card => {
      const brandSlug = card.dataset.brandSlug || '';
      const catId = String(card.dataset.categoryId || '');
      const price = parseInt(card.dataset.price || '0');

      const brandMatch = selectedBrands.length === 0 || selectedBrands.includes(brandSlug);
      const catMatch = selectedCategory === 'all' || selectedCategory === catId;
      const priceMatch = price >= currentMinPrice && price <= currentMaxPrice;

      if (brandMatch && catMatch && priceMatch) {
        card.classList.remove('hidden');
        visible++;
      } else {
        card.classList.add('hidden');
      }
    });

    if (countEl) countEl.textContent = `${visible} Producto${visible !== 1 ? 's' : ''}`;
    if (emptyState) emptyState.classList.toggle('hidden', visible > 0);
    if (productGrid) productGrid.classList.toggle('hidden', visible === 0);
  }

  function syncCatButtons(catId) {
    document.querySelectorAll('.cat-btn').forEach(b => {
      b.classList.toggle('active-cat', b.dataset.catId === catId);
    });
    document.querySelectorAll('.cat-top-btn').forEach(b => {
      const isActive = b.dataset.catId === catId;
      b.classList.toggle('active-cat-top', isActive);
      b.style.background = isActive ? 'black' : '';
      b.style.color = isActive ? 'white' : '';
    });
  }

  // ── Toggle sidebar ──────────────────────────────────────────────
  let sidebarOpen = true;
  const sidebarContent = document.getElementById('sidebar-content');
  const toggleBtn = document.getElementById('toggle-sidebar-btn');
  const toggleLabel = document.getElementById('toggle-sidebar-label');
  const toggleIcon = document.getElementById('toggle-sidebar-icon');

  if (toggleBtn) {
    toggleBtn.addEventListener('click', () => {
      sidebarOpen = !sidebarOpen;
      if (sidebarContent) sidebarContent.classList.toggle('hidden', !sidebarOpen);
      if (toggleLabel) toggleLabel.textContent = sidebarOpen ? 'Ocultar Filtros' : 'Mostrar Filtros';
      if (toggleIcon) toggleIcon.style.transform = sidebarOpen ? '' : 'rotate(180deg)';
    });
  }

  // ── Collapsible sections ────────────────────────────────────────
  [['toggle-cat-btn', 'cat-section', 'cat-arrow'],
   ['toggle-brand-btn', 'brand-section', 'brand-arrow'],
   ['toggle-price-btn', 'price-section', 'price-arrow']].forEach(([btnId, sectionId, arrowId]) => {
    const btn = document.getElementById(btnId);
    const section = document.getElementById(sectionId);
    const arrow = document.getElementById(arrowId);
    let open = true;
    if (btn && section) {
      btn.addEventListener('click', () => {
        open = !open;
        section.classList.toggle('hidden', !open);
        if (arrow) arrow.style.transform = open ? '' : 'rotate(-90deg)';
      });
    }
  });

  // ── Category buttons (sidebar) ──────────────────────────────────
  document.querySelectorAll('.cat-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      selectedCategory = btn.dataset.catId;
      syncCatButtons(selectedCategory);
      applyFilters();
    });
  });

  // ── Top category buttons ────────────────────────────────────────
  document.querySelectorAll('.cat-top-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      selectedCategory = btn.dataset.catId;
      syncCatButtons(selectedCategory);
      applyFilters();
    });
  });

  // ── Brand checkboxes ────────────────────────────────────────────
  document.querySelectorAll('.brand-checkbox').forEach(cb => {
    cb.addEventListener('change', () => {
      const slug = cb.dataset.brandSlug;
      if (cb.checked) {
        if (!selectedBrands.includes(slug)) selectedBrands.push(slug);
      } else {
        selectedBrands = selectedBrands.filter(s => s !== slug);
      }
      applyFilters();
    });
  });

  // ── Brand search ────────────────────────────────────────────────
  const brandSearchEl = document.getElementById('brand-search');
  if (brandSearchEl) {
    brandSearchEl.addEventListener('input', e => {
      const q = e.target.value.toLowerCase();
      document.querySelectorAll('.brand-label').forEach(label => {
        const name = label.dataset.brandName || '';
        label.style.display = name.includes(q) ? '' : 'none';
      });
    });
  }

  // ── Price range ─────────────────────────────────────────────────
  const rangeMin = document.getElementById('price-range-min');
  const rangeMax = document.getElementById('price-range-max');
  const inputMin = document.getElementById('price-input-min');
  const inputMax = document.getElementById('price-input-max');
  const labelMin = document.getElementById('price-min-label');
  const labelMax = document.getElementById('price-max-label');

  function updatePriceUI() {
    if (labelMin) labelMin.textContent = `${currentMinPrice}€`;
    if (labelMax) labelMax.textContent = `${currentMaxPrice}€`;
    if (rangeMin) rangeMin.value = currentMinPrice;
    if (rangeMax) rangeMax.value = currentMaxPrice;
    if (inputMin) inputMin.value = currentMinPrice;
    if (inputMax) inputMax.value = currentMaxPrice;
  }

  if (rangeMin) rangeMin.addEventListener('input', e => {
    currentMinPrice = Math.min(parseInt(e.target.value), currentMaxPrice - 1);
    updatePriceUI(); applyFilters();
  });
  if (rangeMax) rangeMax.addEventListener('input', e => {
    currentMaxPrice = Math.max(parseInt(e.target.value), currentMinPrice + 1);
    updatePriceUI(); applyFilters();
  });
  if (inputMin) inputMin.addEventListener('change', e => {
    currentMinPrice = Math.max(priceMin, Math.min(parseInt(e.target.value) || priceMin, currentMaxPrice - 1));
    updatePriceUI(); applyFilters();
  });
  if (inputMax) inputMax.addEventListener('change', e => {
    currentMaxPrice = Math.min(priceMax, Math.max(parseInt(e.target.value) || priceMax, currentMinPrice + 1));
    updatePriceUI(); applyFilters();
  });

  // ── Sort ────────────────────────────────────────────────────────
  const sortSelect = document.getElementById('sort-select');
  if (sortSelect) {
    sortSelect.addEventListener('change', e => {
      const val = e.target.value;
      const grid = document.getElementById('product-grid');
      if (!grid) return;
      const cardsArr = Array.from(grid.querySelectorAll('.product-card'));
      cardsArr.sort((a, b) => {
        const pa = parseInt(a.dataset.price || '0');
        const pb = parseInt(b.dataset.price || '0');
        if (val === 'price-asc') return pa - pb;
        if (val === 'price-desc') return pb - pa;
        return 0;
      });
      cardsArr.forEach(c => grid.appendChild(c));
    });
  }

  // ── Initial state (brand from URL) ─────────────────────────────
  if (initialBrandSlug) {
    applyFilters();
  }
</script>
