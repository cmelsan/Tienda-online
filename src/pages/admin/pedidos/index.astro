---
export const prerender = false;

import AdminLayout from '@/layouts/AdminLayout.astro';
import AdminOrderRow from '@/components/admin/AdminOrderRow';
import { supabase } from '@/lib/supabase';

// Fetch orders with items and user info
const { data: orders, error } = await supabase
  .from('orders')
  .select(`
    id,
    created_at,
    status,
    total_amount,
    user_id,
    guest_email,
    user:profiles(id, name, email),
    order_items (
      id,
      quantity,
      price_at_purchase,
      product:product_id (
        id,
        name,
        stock
      )
    )
  `)
  .order('created_at', { ascending: false });

if (error) {
  console.error('Error fetching orders:', error);
}

const orderList = orders || [];
---

<AdminLayout title="Pedidos">
  <div class="mb-8 flex justify-between items-center">
    <div>
      <h3 class="text-sm font-bold text-gray-500 uppercase tracking-widest">Ventas</h3>
      <p class="text-xs text-gray-400 mt-1">Gestiona pedidos y devoluciones</p>
    </div>
  </div>

  {orderList && orderList.length > 0 ? (
    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="text-left py-3 px-4 text-xs font-bold text-gray-700 uppercase tracking-wider">ID</th>
              <th class="text-left py-3 px-4 text-xs font-bold text-gray-700 uppercase tracking-wider">Fecha</th>
              <th class="text-left py-3 px-4 text-xs font-bold text-gray-700 uppercase tracking-wider">Cliente</th>
              <th class="text-left py-3 px-4 text-xs font-bold text-gray-700 uppercase tracking-wider">Productos</th>
              <th class="text-left py-3 px-4 text-xs font-bold text-gray-700 uppercase tracking-wider">Total</th>
              <th class="text-left py-3 px-4 text-xs font-bold text-gray-700 uppercase tracking-wider">Estado</th>
              <th class="text-left py-3 px-4 text-xs font-bold text-gray-700 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            {orderList.map((order) => (
              <AdminOrderRow client:load order={order} />
            ))}
          </tbody>
        </table>
      </div>
    </div>
  ) : (
    <div class="bg-white border border-gray-200 p-12 text-center">
      <p class="text-sm text-gray-600">No hay pedidos disponibles</p>
    </div>
  )}
</AdminLayout>
