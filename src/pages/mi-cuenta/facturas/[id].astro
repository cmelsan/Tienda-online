---
export const prerender = false;
import { createServerSupabaseClient } from '@/lib/supabase';
import { formatCents, formatDate } from '@/lib/invoices';

const { id } = Astro.params;

// Auth check
const supabase = await createServerSupabaseClient(Astro);
const { data: { user } } = await supabase.auth.getUser();
if (!user) return Astro.redirect('/login');

// Fetch invoice — RLS solo devuelve facturas de ordenes del usuario
const { data: inv, error } = await supabase
  .from('invoices')
  .select(`
    *,
    orders!invoices_order_id_fkey ( order_number, status, user_id )
  `)
  .eq('id', id!)
  .single();

// Si no existe o pertenece a otro usuario → redirigir
if (error || !inv || (inv as any).orders?.user_id !== user.id) {
  return Astro.redirect('/mi-cuenta/pedidos');
}

const invoice    = inv as any;

// Factura original (para abonos) — query separada para evitar join auto-referencial
let referenceInvoiceNumber: string | null = null;
if (invoice.reference_invoice_id) {
  const { data: refInv } = await supabase
    .from('invoices')
    .select('invoice_number')
    .eq('id', invoice.reference_invoice_id)
    .single();
  referenceInvoiceNumber = refInv?.invoice_number ?? null;
}
const isCreditNote = invoice.type === 'credit_note';
const lineItems    = (invoice.line_items as any[]) || [];
const address      = invoice.customer_address || {};

const docTitle = isCreditNote
  ? `Factura de abono${invoice.credit_note_scope === 'partial' ? ' (parcial)' : ''}`
  : 'Factura de venta';
---

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{invoice.invoice_number} — ÉCLAT Beauty</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 13px; color: #111; background: #f5f5f5; }

    .page { max-width: 820px; margin: 40px auto; background: #fff; padding: 56px 64px; box-shadow: 0 2px 24px rgba(0,0,0,.08); }

    /* ── Cabecera ── */
    .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; border-bottom: 3px solid #000; padding-bottom: 28px; }
    .brand-name { font-size: 24px; font-weight: 900; letter-spacing: -0.5px; text-transform: uppercase; }
    .brand-sub  { font-size: 9px; color: #888; letter-spacing: 2px; text-transform: uppercase; margin-top: 4px; }
    .doc-meta   { text-align: right; }
    .doc-type   { font-size: 9px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; color: #888; }
    .doc-number { font-size: 20px; font-weight: 900; font-family: monospace; margin-top: 4px; }
    .doc-date   { font-size: 11px; color: #888; margin-top: 4px; }

    /* ── Banner abono ── */
    .credit-banner { background: #000; color: #fff; padding: 10px 16px; font-size: 10px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 32px; display: flex; justify-content: space-between; align-items: center; }
    .credit-banner .ref { color: #aaa; font-weight: 400; }

    /* ── Emisor / Receptor ── */
    .parties { display: grid; grid-template-columns: 1fr 1fr; margin-bottom: 40px; border: 1px solid #e8e8e8; }
    .party { padding: 20px 24px; }
    .party:first-child { border-right: 1px solid #e8e8e8; }
    .party-label { font-size: 9px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: #888; margin-bottom: 8px; }
    .party-name  { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
    .party-info  { font-size: 12px; color: #444; line-height: 1.7; }

    /* ── Tabla ── */
    .order-ref { margin-bottom: 20px; font-size: 11px; color: #888; }
    .order-ref strong { color: #111; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 0; }
    thead tr { background: #000; color: #fff; }
    thead th { padding: 10px 12px; font-size: 9px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; text-align: left; color: #fff; }
    thead th.r { text-align: right; }
    thead th.c { text-align: center; }
    tbody tr { border-bottom: 1px solid #e5e7eb; }
    tbody tr:last-child { border-bottom: none; }
    tbody td { padding: 12px; font-size: 12px; vertical-align: top; }
    tbody td.r { text-align: right; }
    tbody td.c { text-align: center; color: #888; }
    tbody td.bold { font-weight: 700; text-align: right; }
    tbody td.neg  { color: #dc2626; }

    /* ── Totales ── */
    .totals-wrap  { display: flex; justify-content: flex-end; margin-top: 4px; border-top: 2px solid #000; }
    .totals       { width: 320px; }
    .totals-row   { display: flex; justify-content: space-between; padding: 8px 12px; font-size: 12px; border-bottom: 1px solid #f0f0f0; }
    .totals-total { display: flex; justify-content: space-between; padding: 13px 12px; font-size: 15px; font-weight: 900; background: #000; color: #fff; }
    .totals-total.credit { background: #dc2626; }

    /* ── Notas ── */
    .notes { margin-top: 36px; padding: 14px 18px; border-left: 3px solid #000; background: #f9f9f9; font-size: 11px; color: #444; line-height: 1.6; }
    .notes strong { display: block; font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: #888; margin-bottom: 6px; }

    /* ── Pie ── */
    .footer { margin-top: 48px; padding-top: 20px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; font-size: 10px; color: #aaa; letter-spacing: 1px; }

    /* ── Botones fijos ── */
    .btn-bar { position: fixed; top: 24px; right: 24px; display: flex; gap: 10px; }
    .btn-bar a, .btn-bar button {
      padding: 11px 22px; font-size: 10px; font-weight: 700; letter-spacing: 2px;
      text-transform: uppercase; cursor: pointer; border: none; text-decoration: none;
    }
    .btn-back  { background: #f3f4f6; color: #111; }
    .btn-print { background: #000; color: #fff; }
    .btn-print:hover { background: #ec4899; }

    @media print {
      body { background: #fff; }
      .page { margin: 0; padding: 32px; max-width: 100%; box-shadow: none; }
      .no-print { display: none !important; }
      @page { margin: 1cm; }
    }
  </style>
</head>
<body>
  <!-- Botones fijos -->
  <div class="btn-bar no-print">
    <a href="/mi-cuenta/pedidos" class="btn-back">← Mis Pedidos</a>
    <button onclick="window.print()" class="btn-print">Imprimir / PDF</button>
  </div>

  <div class="page">
    <!-- Cabecera -->
    <div class="header">
      <div>
        <div class="brand-name">Éclat Beauty</div>
        <div class="brand-sub">Tienda online de cosmética</div>
      </div>
      <div class="doc-meta">
        <div class="doc-type">{docTitle}</div>
        <div class="doc-number">{invoice.invoice_number}</div>
        <div class="doc-date">{formatDate(invoice.issued_at)}</div>
      </div>
    </div>

    <!-- Banner abono -->
    {isCreditNote && (
      <div class="credit-banner">
        <span>
          Factura de abono —
          {invoice.credit_note_scope === 'partial' ? ' devolución parcial' : ' devolución total'}
        </span>
        {referenceInvoiceNumber && (
          <span class="ref">Ref. factura original: {referenceInvoiceNumber}</span>
        )}
      </div>
    )}

    <!-- Emisor / Receptor -->
    <div class="parties">
      <div class="party">
        <div class="party-label">Emisor</div>
        <div class="party-name">Éclat Beauty S.L.</div>
        <div class="party-info">
          CIF: B-XXXXXXXX<br />
          Calle Ejemplo, 1<br />
          28001 Madrid, España<br />
          hola@eclatbeauty.com
        </div>
      </div>
      <div class="party">
        <div class="party-label">Cliente</div>
        <div class="party-name">{invoice.customer_name || 'Cliente'}</div>
        <div class="party-info">
          {invoice.customer_email && <>{invoice.customer_email}<br /></>}
          {invoice.customer_nif && <>NIF/CIF: {invoice.customer_nif}<br /></>}
          {address.address && <>{address.address}<br /></>}
          {address.city && <>{address.city}{address.province ? `, ${address.province}` : ''}<br /></>}
          {address.postal_code && <>{address.postal_code} {address.country || 'España'}</>}
        </div>
      </div>
    </div>

    <!-- Referencia pedido -->
    <div class="order-ref">
      Pedido: <strong>#{invoice.orders?.order_number || invoice.order_id.slice(0, 8)}</strong>
    </div>

    <!-- Líneas -->
    <table>
      <thead>
        <tr>
          <th style="width:50%">Descripción</th>
          <th class="c">Cant.</th>
          <th class="r">P. unitario</th>
          <th class="r">Base imp.</th>
          <th class="r">IVA {invoice.tax_rate}%</th>
          <th class="r">Total</th>
        </tr>
      </thead>
      <tbody>
        {lineItems.map((item: any) => {
          const gross = Math.abs(item.unit_price_gross);
          const net   = Math.abs(item.unit_price_net);
          const tax   = gross - net;
          const qty   = item.quantity;
          const total = Math.abs(item.line_total);
          return (
            <tr>
              <td>{item.name}</td>
              <td class="c">{qty}</td>
              <td class="r">{formatCents(gross)}</td>
              <td class="r">{formatCents(net * qty)}</td>
              <td class="r">{formatCents(tax * qty)}</td>
              <td class={`bold${isCreditNote ? ' neg' : ''}`}>
                {isCreditNote && '-'}{formatCents(total)}
              </td>
            </tr>
          );
        })}
      </tbody>
    </table>

    <!-- Totales -->
    <div class="totals-wrap">
      <div class="totals">
        <div class="totals-row">
          <span>Base imponible</span>
          <span>{isCreditNote && '-'}{formatCents(Math.abs(invoice.subtotal))}</span>
        </div>
        {invoice.discount_amount > 0 && (
          <div class="totals-row">
            <span>Descuento (cupón)</span>
            <span>-{formatCents(invoice.discount_amount)}</span>
          </div>
        )}
        <div class="totals-row">
          <span>IVA ({invoice.tax_rate}%)</span>
          <span>{isCreditNote && '-'}{formatCents(Math.abs(invoice.tax_amount))}</span>
        </div>
        <div class={`totals-total${isCreditNote ? ' credit' : ''}`}>
          <span>TOTAL</span>
          <span>{isCreditNote && '-'}{formatCents(Math.abs(invoice.total_amount))}</span>
        </div>
      </div>
    </div>

    <!-- Notas -->
    {invoice.notes && (
      <div class="notes">
        <strong>Notas</strong>
        {invoice.notes}
      </div>
    )}

    <!-- Pie -->
    <div class="footer">
      <span>Éclat Beauty S.L. — CIF: B-XXXXXXXX</span>
      <span>Documento generado el {formatDate(new Date().toISOString())}</span>
    </div>
  </div>
</body>
</html>
