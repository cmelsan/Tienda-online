---
export const prerender = false;
import AdminLayout from '@/layouts/AdminLayout.astro';
import AdminReturnRow from '@/components/admin/AdminReturnRow';
import { createServerSupabaseClient } from '@/lib/supabase';

// Fetch all orders with return_requested or returned status
const supabase = await createServerSupabaseClient(Astro, true);

const { data: returnRequests } = await supabase
  .from('orders')
  .select(`
    id,
    order_number,
    created_at,
    status,
    total_amount,
    user_id,
    guest_email,
    delivered_at,
    order_items (
      id,
      product_id,
      quantity,
      price_at_purchase,
      return_status,
      return_reason,
      products (
        name,
        images
      )
    ),
    order_status_history!order_status_history_order_id_fkey (
      notes,
      created_at
    )
  `)
  .in('status', ['return_requested', 'returned', 'partially_returned', 'refunded', 'partially_refunded'])
  .order('created_at', { ascending: false });

const formatDate = (dateStr: string) => {
    return new Date(dateStr).toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
};

const formatPrice = (amount: number) => {
    return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(amount / 100);
};

const getBadgeClass = (status: string) => {
  if (status === 'refunded' || status === 'partially_refunded') return 'bg-gray-100 text-gray-500 border border-gray-300';
  if (status === 'returned' || status === 'partially_returned') return 'bg-gray-800 text-white';
  return 'bg-black text-white';
};

const getStatusLabel = (status: string) => {
  if (status === 'refunded') return 'Reembolso Completado';
  if (status === 'partially_refunded') return 'Reembolso Parcial Completado';
  if (status === 'partially_returned') return 'Parcialmente Devuelto';
  if (status === 'returned') return 'Devuelto — Reembolso Pendiente';
  return 'Devolución Solicitada';
};

const getItemBadge = (returnStatus: string | null) => {
  if (returnStatus === 'requested') return { label: 'Solicitado', cls: 'bg-black text-white' };
  if (returnStatus === 'approved') return { label: 'Aprobado', cls: 'bg-gray-700 text-white' };
  if (returnStatus === 'rejected') return { label: 'Rechazado', cls: 'bg-red-600 text-white' };
  if (returnStatus === 'refunded') return { label: 'Reembolsado', cls: 'bg-gray-100 text-gray-500' };
  return { label: 'Sin devolución', cls: 'bg-gray-100 text-gray-400' };
};

const totalReturns = returnRequests?.length || 0;
const pendingCount = returnRequests?.filter((o: any) => o.status === 'return_requested')?.length || 0;
const awaitingRefund = returnRequests?.filter((o: any) => o.status === 'returned' || o.status === 'partially_returned')?.length || 0;
const refundedCount = returnRequests?.filter((o: any) => o.status === 'refunded' || o.status === 'partially_refunded')?.length || 0;
---

<AdminLayout title="Gestión de Devoluciones" description="Procesar solicitudes de devolución">
  <div class="space-y-6">
    <!-- Stats -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
      <div class="bg-black text-white p-5">
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400">Total</p>
        <p class="text-3xl font-bold mt-1">{totalReturns}</p>
      </div>
      <div class="bg-white border border-gray-200 p-5">
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400">Solicitadas</p>
        <p class="text-3xl font-bold text-black mt-1">{pendingCount}</p>
      </div>
      <div class="bg-white border border-gray-200 p-5">
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400">Pendiente reembolso</p>
        <p class="text-3xl font-bold text-black mt-1">{awaitingRefund}</p>
      </div>
      <div class="bg-white border border-gray-200 p-5">
        <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400">Reembolsadas</p>
        <p class="text-3xl font-bold text-black mt-1">{refundedCount}</p>
      </div>
    </div>

    <!-- Header -->
    <div>
      <h2 class="text-sm font-bold uppercase tracking-widest text-black">Devoluciones</h2>
      <p class="text-xs text-gray-400 mt-1">Revisar, aprobar/rechazar devoluciones y procesar reembolsos</p>
    </div>

    <!-- Buscador -->
    <div>
      <div class="relative">
        <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0z"/>
        </svg>
        <input
          id="search-devoluciones"
          type="text"
          placeholder="Buscar por nº pedido o email..."
          class="w-full pl-11 pr-4 py-3 bg-white border border-gray-200 text-sm placeholder-gray-400 focus:outline-none focus:border-black transition-colors"
        />
      </div>
      <p id="search-count-devoluciones" class="text-[10px] text-gray-400 mt-2 hidden uppercase tracking-widest"></p>
    </div>

    {/* Empty State */}
    {(!returnRequests || returnRequests.length === 0) ? (
      <div class="bg-white border border-gray-200 p-12 text-center">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-50 mb-4">
          <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <h3 class="text-sm font-bold text-black mb-1 uppercase tracking-widest">Sin solicitudes pendientes</h3>
        <p class="text-xs text-gray-400">Todas las devoluciones han sido procesadas</p>
      </div>
    ) : (
      <div class="space-y-4">
        {returnRequests.map((order: any) => {
          // Get return reason from status history
          const returnHistory = order.order_status_history?.find((h: any) => h.notes);
          const returnReason = returnHistory?.notes || 'Sin motivo especificado';
          const requestDate = returnHistory?.created_at || order.created_at;
          const isRefundStage = order.status === 'returned' || order.status === 'partially_returned';
          const isRefunded = order.status === 'refunded' || order.status === 'partially_refunded';
          const badgeClass = getBadgeClass(order.status);
          const statusLabel = getStatusLabel(order.status);

          // Calcular reembolso de los items en devolución
          const returnItems = order.order_items?.filter((i: any) => 
            i.return_status === 'requested' || i.return_status === 'approved'
          ) || [];
          const refundAmount = returnItems.reduce((sum: number, i: any) => 
            sum + (i.price_at_purchase * i.quantity), 0
          );

          return (
            <div
              class="bg-white border border-gray-200 overflow-hidden"
              data-search={`${order.order_number} ${order.guest_email || ''} ${order.user_id || ''}`.toLowerCase()}
            >
              {/* Cabecera */}
              <div class="px-6 py-4 border-b bg-gray-50 border-gray-100">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                  <div class="flex gap-8 text-sm">
                    <div>
                      <span class="block text-gray-600 font-medium text-xs uppercase">Pedido</span>
                      <span class="font-bold text-gray-900">#{order.order_number}</span>
                    </div>
                    <div>
                      <span class="block text-gray-600 font-medium text-xs uppercase">Cliente</span>
                      <span class="font-medium text-gray-900">{order.guest_email || order.user_id?.slice(0, 8) || 'N/A'}</span>
                    </div>
                    <div>
                      <span class="block text-gray-600 font-medium text-xs uppercase">Total Pedido</span>
                      <span class="font-bold text-gray-900">{formatPrice(order.total_amount)}</span>
                      {refundAmount > 0 && refundAmount < order.total_amount && (
                        <span class="block text-[10px] text-gray-500 font-medium">Reembolso: {formatPrice(refundAmount)}</span>
                      )}
                    </div>
                    <div>
                      <span class="block text-gray-600 font-medium text-xs uppercase">Solicitado</span>
                      <span class="text-gray-900">{formatDate(requestDate)}</span>
                    </div>
                  </div>
                  
                  <span class={`px-3 py-1 text-[10px] font-bold uppercase tracking-widest ${badgeClass}`}>
                    {statusLabel}
                  </span>
                </div>
              </div>

              {/* Return Details */}
              <div class="px-6 py-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Products */}
                <div>
                  <h4 class="text-xs font-bold uppercase tracking-wider text-gray-500 mb-3">Productos</h4>
                  <div class="space-y-3">
                    {order.order_items?.map((item: any) => {
                      return (
                        <div class="flex items-center gap-3 p-2 bg-gray-50 border border-gray-100">
                          <div class="w-12 h-12 bg-gray-100 rounded overflow-hidden flex-shrink-0">
                            {item.products?.images?.[0] && (
                              <img src={item.products.images[0]} alt={item.products.name} class="w-full h-full object-cover" />
                            )}
                          </div>
                          <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">{item.products?.name}</p>
                            <p class="text-xs text-gray-500">Cantidad: {item.quantity} × {formatPrice(item.price_at_purchase)}</p>
                            {item.return_reason && (
                              <p class="text-xs text-gray-400 mt-0.5">Motivo: {item.return_reason}</p>
                            )}
                          </div>
                          {(() => { const b = getItemBadge(item.return_status); return (
                            <span class={`flex-shrink-0 text-[10px] font-bold px-2 py-1 uppercase tracking-wider ${b.cls}`}>{b.label}</span>
                          ); })()}
                        </div>
                      );
                    })}
                  </div>

                  {/* Resumen de reembolso */}
                  {(() => {
                    const returnItems = order.order_items?.filter((i: any) => 
                      i.return_status === 'requested' || i.return_status === 'approved'
                    ) || [];
                    const refundAmount = returnItems.reduce((sum: number, i: any) => 
                      sum + (i.price_at_purchase * i.quantity), 0
                    );
                    const totalItems = order.order_items?.length || 0;
                    if (returnItems.length > 0 && returnItems.length < totalItems) {
                      return (
                        <div class="mt-3 bg-gray-100 border border-gray-200 p-3">
                          <p class="text-[10px] font-bold text-black uppercase tracking-widest">
                            Devolución parcial: {returnItems.length} de {totalItems} productos
                          </p>
                          <p class="text-xs text-gray-500 mt-1">
                            Reembolso estimado: {formatPrice(refundAmount)} de {formatPrice(order.total_amount)}
                          </p>
                        </div>
                      );
                    }
                    return null;
                  })()}
                </div>

                {/* Reason */}
                {!isRefundStage && (
                  <div>
                    <h4 class="text-xs font-bold uppercase tracking-wider text-gray-500 mb-3">Motivo de Devolución</h4>
                    <div class="bg-gray-50 p-4 border border-gray-100">
                      <p class="text-sm text-gray-700">{returnReason}</p>
                    </div>
                  </div>
                )}
              </div>

              {/* Actions (Using Client Component) */}
              <div class="px-6 py-4 bg-gray-50 border-t border-gray-100">
                <AdminReturnRow 
                  client:visible 
                  orderId={order.id}
                  orderTotalCents={order.total_amount}
                  refundAmountCents={refundAmount || order.total_amount}
                  orderStatus={order.status}
                />
              </div>
            </div>
          );
        })}
      </div>
    )}
  </div>
</AdminLayout>

<script>
  declare global {
    interface Window {
      AdminReturnRow: any;
    }
  }
</script>

<script>
  const searchDev = document.getElementById('search-devoluciones') as HTMLInputElement;
  const countDev = document.getElementById('search-count-devoluciones') as HTMLParagraphElement;

  searchDev?.addEventListener('input', () => {
    const q = searchDev.value.toLowerCase().trim();
    const cards = document.querySelectorAll<HTMLDivElement>('[data-search]');
    let visible = 0;

    cards.forEach(card => {
      const match = !q || (card.dataset.search || '').includes(q);
      card.style.display = match ? '' : 'none';
      if (match) visible++;
    });

    if (q) {
      countDev.textContent = `${visible} devolución${visible !== 1 ? 'es' : ''} encontrada${visible !== 1 ? 's' : ''}`;
      countDev.classList.remove('hidden');
    } else {
      countDev.classList.add('hidden');
    }
  });
</script>
