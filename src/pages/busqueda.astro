---
import PublicLayout from '@/layouts/PublicLayout.astro';
import ProductCard from '@/components/product/ProductCard.astro';
import { supabase } from '@/lib/supabase';

const q = Astro.url.searchParams.get('q') || '';
const brandFilter = Astro.url.searchParams.get('brand') || '';
const queryClean = q.trim();

let products = [];
let error = null;
let searchTitle = 'Buscar Productos';

if (queryClean || brandFilter) {
    let query = supabase
        .from('products')
        .select('*, brand:brands(name), category:categories(slug)');
    
    // Filter by text search if query exists
    if (queryClean) {
        query = query.or(`name.ilike.%${queryClean}%,description.ilike.%${queryClean}%`);
        searchTitle = `Resultados para "${queryClean}"`;
    }
    
    // Filter by brand if brand parameter exists
    if (brandFilter) {
        // First, find the brand by name
        const { data: brandData } = await supabase
            .from('brands')
            .select('id')
            .eq('name', brandFilter)
            .single();
        
        if (brandData?.id) {
            query = query.eq('brand_id', brandData.id);
        }
        searchTitle = `Productos de ${brandFilter}`;
    }
    
    const { data, error: err } = await query.order('created_at', { ascending: false });
        
    if (err) {
        console.error('Search error:', err);
        error = "Hubo un error al realizar la búsqueda.";
    } else {
        products = data || [];
    }
}

// Fetch Offers Settings
const { data: offersSettingData } = await supabase
  .from('app_settings')
  .select('value')
  .eq('key', 'offers_enabled')
  .single();

const offersEnabled = offersSettingData?.value === true;

// Fetch Featured Offers if enabled
let featuredOffers: any[] = [];
if (offersEnabled) {
  const { data: offersData } = await supabase
    .from('app_settings')
    .select('value')
    .eq('key', 'featured_offers')
    .single();
  
  if (offersData?.value) {
    featuredOffers = offersData.value;
  }
}

// Add discount info to products if offers are enabled
const productsWithDiscounts = products.map(product => {
  const offer = featuredOffers.find(o => o.id === product.id);
  return {
    ...product,
    discount: offer?.discount || 0,
    discountedPrice: offer ? Math.round(product.price * (1 - offer.discount / 100)) : 0
  };
});
---

<PublicLayout title={`${searchTitle} | ÉCLAT`} description="Resultados de búsqueda">
    <div class="max-w-[1920px] mx-auto px-4 sm:px-6 lg:px-12 py-12">
        
        <header class="mb-12 text-center">
            <h1 class="text-3xl lg:text-5xl font-bold uppercase tracking-tight mb-4">
                {queryClean ? 'Resultados de Búsqueda' : brandFilter ? brandFilter.toUpperCase() : 'Buscar Productos'}
            </h1>
            {(queryClean || brandFilter) && (
                 <p class="text-gray-500 text-lg">
                    Se han encontrado <span class="font-bold text-black">{products.length}</span> resultados{queryClean ? ` para "${queryClean}"` : ` de ${brandFilter}`}
                </p>
            )}
        </header>

        {products.length > 0 ? (
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-12">
                {productsWithDiscounts.map((product) => {
                     // Determine fallback image based on category
                    const catSlug = product.category?.slug || 'maquillaje';
                    const fallbackImage = `/assets/products/${
                        catSlug === 'maquillaje' ? 'makeup-default.png' :
                        catSlug === 'cabello' ? 'hair-default.png' :
                        catSlug === 'cuerpo' ? 'body-default.png' :
                        catSlug === 'perfumes' ? 'perfume-default.png' :
                        'makeup-default.png'
                    }`;

                    return (
                        <ProductCard 
                            product={{
                                ...product,
                                brand: product.brand?.name || 'ÉCLAT'
                            }}
                            fallbackImage={fallbackImage}
                        />
                    );
                })}
            </div>
        ) : (
            <div class="flex flex-col items-center justify-center py-20 bg-gray-50 rounded-lg border border-dashed border-gray-200">
                <div class="mb-6 text-gray-300">
                    <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <h2 class="text-xl font-bold mb-2 uppercase tracking-widest">No encontramos nada</h2>
                <p class="text-gray-500 mb-8 max-w-md text-center">
                    Lo sentimos, no hemos encontrado productos que coincidan con "<strong>{queryClean}</strong>". 
                    Intenta con otra palabra clave o revisa la ortografía.
                </p>
                <a href="/" class="bg-black text-white px-8 py-3 text-xs font-bold uppercase tracking-widest hover:bg-gray-800 transition-colors">
                    Volver al Inicio
                </a>
            </div>
        )}

    </div>
</PublicLayout>
