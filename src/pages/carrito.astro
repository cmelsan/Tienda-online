---
export const prerender = false;

import PublicLayout from '@/layouts/PublicLayout.astro';
---

<PublicLayout
  title="Carrito de Compra - ÉCLAT"
  description="Revisa tu carrito de compra"
>
  <div class="min-h-screen bg-gradient-to-b from-gray-50 to-white py-12">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="mb-12">
        <h1 class="text-4xl md:text-5xl font-sans font-light text-black mb-2">
          Tu Carrito
        </h1>
        <p class="text-gray-500 text-lg">Revisa y modifica tus artículos antes de finalizar</p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2">
          <div id="cart-container" class="min-h-40"></div>
        </div>
        <div id="summary-container" class="lg:col-span-1"></div>
      </div>
    </div>
  </div>
</PublicLayout>

<script>
  import { cartItemsArray, appliedCoupon, applyCoupon } from '@/stores/cart';
  import { formatPrice } from '@/lib/utils';

  const container = document.getElementById('cart-container');
  const summaryContainer = document.getElementById('summary-container');
  
  function calculateTotal() {
    const items = cartItemsArray.get();
    const coupon = appliedCoupon.get();
    
    let subtotal = 0;
    if (items && items.length > 0) {
      subtotal = items.reduce((sum, item) => {
        if (item?.product?.price && item?.quantity) {
          return sum + (item.product.price * item.quantity);
        }
        return sum;
      }, 0);
    }
    
    if (coupon && coupon.discount_amount && coupon.discount_amount > 0) {
      return Math.max(0, subtotal - coupon.discount_amount);
    }
    
    return subtotal;
  }

  function renderCart() {
    const items = cartItemsArray.get();
    const coupon = appliedCoupon.get();
    
    if (!container || !summaryContainer) return;

    if (!items || items.length === 0) {
      container.innerHTML = `
        <div class="bg-white rounded-xl border border-gray-200 p-12 text-center">
          <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
            </svg>
          </div>
          <p class="text-2xl font-bold text-gray-900 mb-2">Tu carrito está vacío</p>
          <p class="text-gray-500 mb-8">Explora nuestros productos y añade los que te gusten</p>
          <a href="/productos" class="inline-block px-8 py-3 bg-black text-white rounded-lg font-semibold hover:bg-gray-800 transition-colors">
            Explorar Productos
          </a>
        </div>
      `;
      
      summaryContainer.innerHTML = `
        <div class="bg-white rounded-xl border border-gray-200 p-6 sticky top-8">
          <h2 class="text-xl font-bold text-black mb-6">Resumen</h2>
          <div class="space-y-4 text-center py-8 text-gray-500">
            <p>Añade artículos para ver el resumen</p>
          </div>
        </div>
      `;
      return;
    }

    // Render cart items
    let subtotal = 0;
    if (items && items.length > 0) {
      subtotal = items.reduce((sum, item) => {
        if (item?.product?.price && item?.quantity) {
          return sum + (item.product.price * item.quantity);
        }
        return sum;
      }, 0);
    }
    
    const total = calculateTotal();

    container.innerHTML = `
      <div class="space-y-4">
        ${items.map((item, index) => `
          <div class="group bg-white rounded-xl border border-gray-200 p-6 hover:border-gray-300 hover:shadow-lg transition-all duration-300">
            <div class="flex gap-6">
              <div class="relative w-24 h-24 flex-shrink-0">
                <img
                  src="${item.product.images[0] || '/placeholder-product.jpg'}"
                  alt="${item.product.name}"
                  class="w-full h-full object-cover rounded-lg border border-gray-100"
                />
                <div class="absolute top-2 right-2 bg-black text-white text-xs font-bold px-2 py-1 rounded">
                  ${item.quantity}x
                </div>
              </div>

              <div class="flex-1">
                <h3 class="font-bold text-lg text-black mb-1">
                  ${item.product.name}
                </h3>
                <p class="text-sm text-gray-500 mb-4">Ref: ${item.product.slug}</p>
                
                <div class="flex items-center space-x-2 bg-gray-100 rounded-lg w-fit p-1">
                  <button 
                    onclick="window.dispatchEvent(new CustomEvent('update-quantity', { detail: { id: '${item.product.id}', qty: ${item.quantity - 1} } }))"
                    class="w-8 h-8 flex items-center justify-center hover:bg-white rounded transition-colors text-gray-700 font-bold"
                  >
                    −
                  </button>
                  <span class="text-sm font-bold text-gray-900 w-6 text-center">${item.quantity}</span>
                  <button 
                    onclick="window.dispatchEvent(new CustomEvent('update-quantity', { detail: { id: '${item.product.id}', qty: ${item.quantity + 1} } }))"
                    class="w-8 h-8 flex items-center justify-center hover:bg-white rounded transition-colors text-gray-700 font-bold"
                  >
                    +
                  </button>
                </div>
              </div>

              <div class="flex flex-col items-end justify-between">
                <p class="text-xl font-bold text-black">
                  ${formatPrice(item.product.price * item.quantity)}
                </p>
                <button 
                  onclick="window.dispatchEvent(new CustomEvent('remove-from-cart', { detail: { id: '${item.product.id}' } }))"
                  class="text-red-600 hover:text-red-700 transition-colors opacity-0 group-hover:opacity-100"
                  title="Eliminar"
                >
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    `;

    // Render summary
    summaryContainer.innerHTML = `
      <div class="space-y-6">
        <div class="bg-white rounded-xl border border-gray-200 p-6">
          <h3 class="font-bold text-black mb-4">Código de Descuento</h3>
          <div class="space-y-3">
            ${coupon && coupon.code ? `
              <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" />
                    </svg>
                    <span class="text-sm font-semibold text-green-900">${coupon.code}</span>
                  </div>
                  <button 
                    onclick="window.dispatchEvent(new CustomEvent('remove-coupon'))"
                    class="text-xs text-green-600 hover:text-green-800 underline"
                  >
                    Remover
                  </button>
                </div>
              </div>
            ` : `
              <input 
                type="text" 
                id="coupon-input"
                placeholder="Ingresa tu código"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-black transition-colors"
              />
              <button 
                onclick="window.dispatchEvent(new CustomEvent('apply-coupon'))"
                class="w-full px-4 py-2 bg-black text-white rounded-lg text-sm font-semibold hover:bg-gray-800 transition-colors"
              >
                Aplicar Código
              </button>
            `}
          </div>
        </div>

        <div class="bg-white rounded-xl border border-gray-200 p-6">
          <h3 class="font-bold text-black mb-4">Resumen de Pedido</h3>
          <div class="space-y-3 pb-4 border-b border-gray-200">
            <div class="flex justify-between text-sm text-gray-600">
              <span>Subtotal</span>
              <span class="font-semibold text-black">${formatPrice(subtotal)}</span>
            </div>
            ${coupon && coupon.code && coupon.discount_amount && coupon.discount_amount > 0 ? `
              <div class="flex justify-between text-sm text-green-600">
                <span>Descuento</span>
                <span class="font-semibold">-${formatPrice(coupon.discount_amount)}</span>
              </div>
            ` : `
              <div class="flex justify-between text-sm text-gray-400">
                <span>Envío</span>
                <span class="font-semibold">GRATIS</span>
              </div>
            `}
          </div>
          
          <div class="flex justify-between items-center pt-4 mb-6">
            <span class="text-lg font-bold text-black">Total</span>
            <span class="text-2xl font-bold text-black">${formatPrice(total)}</span>
          </div>

          <div class="space-y-2">
            <a href="/checkout" class="block w-full px-6 py-3 bg-black text-white text-center rounded-lg font-semibold hover:bg-gray-900 transition-all duration-200 transform hover:scale-105 active:scale-95">
              Finalizar Compra
            </a>
            <a href="/productos" class="block w-full px-6 py-3 border-2 border-gray-300 text-gray-900 text-center rounded-lg font-semibold hover:border-gray-400 hover:bg-gray-50 transition-colors">
              Seguir Comprando
            </a>
          </div>
        </div>

        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border border-blue-200 p-4 space-y-3">
          <div class="flex items-start space-x-3">
            <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.5c4.82 0 9.162 2.001 12.166 5.247M2 10a8 8 0 1 1 16 0 8 8 0 0 1-16 0zm11.334 5.001A6 6 0 0 0 10 18a6 6 0 0 1-1.334-8zm4.612-4.346a9 9 0 1 0-12.454 0 9 9 0 0 0 12.454 0z" clip-rule="evenodd" />
            </svg>
            <div class="text-sm">
              <p class="font-semibold text-blue-900">Compra Segura</p>
              <p class="text-blue-700 text-xs">Pago encriptado con Stripe</p>
            </div>
          </div>
          <div class="flex items-start space-x-3">
            <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />
              <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0015.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z" />
            </svg>
            <div class="text-sm">
              <p class="font-semibold text-blue-900">Envío Rápido</p>
              <p class="text-blue-700 text-xs">Entrega en 24-48h</p>
            </div>
          </div>
          <div class="flex items-start space-x-3">
            <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
            <div class="text-sm">
              <p class="font-semibold text-blue-900">Devoluciones Fáciles</p>
              <p class="text-blue-700 text-xs">30 días para cambios</p>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Event listeners
  window.addEventListener('update-quantity', (e: any) => {
    const { updateQuantity } = require('@/stores/cart');
    try {
      updateQuantity(e.detail.id, e.detail.qty);
    } catch (err: any) {
      alert(err instanceof Error ? err.message : 'Error');
    }
  });

  window.addEventListener('remove-from-cart', (e: any) => {
    const { removeFromCart } = require('@/stores/cart');
    removeFromCart(e.detail.id);
  });

  // Elemento para mostrar mensajes de cupón (error y éxito)
  let couponErrorElement = document.getElementById('coupon-error');
  let couponSuccessElement = document.getElementById('coupon-success');
  
  function showCouponMessage(message: string, isError: boolean = false) {
    if (!couponErrorElement) {
      couponErrorElement = document.createElement('div');
      couponErrorElement.id = 'coupon-error';
      const input = document.getElementById('coupon-input');
      input?.parentElement?.parentElement?.insertBefore(couponErrorElement, input?.parentElement?.nextSibling);
    }
    
    couponErrorElement.innerHTML = message;
    couponErrorElement.className = isError 
      ? 'text-red-600 text-xs mt-2 p-2 bg-red-50 rounded border border-red-200'
      : 'text-green-600 text-xs mt-2 p-2 bg-green-50 rounded border border-green-200';
    
    // Auto-clear success message after 5 seconds
    if (!isError) {
      setTimeout(() => {
        couponErrorElement!.innerHTML = '';
        couponErrorElement!.className = '';
      }, 5000);
    }
  }
  
  window.addEventListener('apply-coupon', () => {
    const input = document.getElementById('coupon-input') as HTMLInputElement;
    
    if (!input || !input.value.trim()) {
      showCouponMessage('Por favor ingresa un código de descuento', true);
      return;
    }

    const items = cartItemsArray.get();
    const subtotal = items.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);

    // Show loading state
    showCouponMessage('Validando código...', false);

    fetch('/api/checkout/validate-coupon', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        code: input.value.toUpperCase(),
        totalAmount: subtotal
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.valid) {
        applyCoupon({
          code: data.coupon.code,
          id: data.coupon.id,
          discount_value: data.coupon.discount_value,
          discount_type: data.coupon.discount_type,
          discount_amount: data.coupon.discount_amount
        });
        // Show success message with discount amount
        const discountAmount = (data.coupon.discount_amount / 100).toFixed(2);
        showCouponMessage(`✓ Cupón ${data.coupon.code} aplicado: €${discountAmount} de descuento`, false);
      } else {
        showCouponMessage(data.error || 'Código inválido', true);
      }
    })
    .catch(err => {
      showCouponMessage('Error de conexión: ' + err.message, true);
    });
  });

  window.addEventListener('remove-coupon', () => {
    const { removeCoupon } = require('@/stores/cart');
    removeCoupon();
    // Clear messages when removing coupon
    if (couponErrorElement) {
      couponErrorElement.innerHTML = '';
      couponErrorElement.className = '';
    }
  });

  // Subscribe to changes
  cartItemsArray.subscribe(() => renderCart());
  appliedCoupon.subscribe(() => renderCart());
  
  // Initial render
  renderCart();
</script>

<script>
  import { cartItemsArray, appliedCoupon } from '@/stores/cart';
  import { formatPrice } from '@/lib/utils';

  const container = document.getElementById('cart-container');
  const checkoutSection = document.getElementById('checkout-section');
  
  function calculateTotal() {
    const items = cartItemsArray.get();
    const coupon = appliedCoupon.get();
    
    // Calcular subtotal
    let subtotal = 0;
    if (items && items.length > 0) {
      subtotal = items.reduce((sum, item) => {
        if (item?.product?.price && item?.quantity) {
          return sum + (item.product.price * item.quantity);
        }
        return sum;
      }, 0);
    }
    
    // Aplicar descuento si existe
    if (coupon && coupon.discount_amount && coupon.discount_amount > 0) {
      return Math.max(0, subtotal - coupon.discount_amount);
    }
    
    return subtotal;
  }

  function renderCart() {
    const items = cartItemsArray.get();
    const coupon = appliedCoupon.get();
    
    if (!container) return;

    if (!items || items.length === 0) {
      if (checkoutSection) checkoutSection.style.display = 'none';
      container.innerHTML = `
        <div class="text-center py-20 bg-gray-50 rounded-lg">
          <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
          </svg>
          <p class="text-xl font-bold text-gray-900 mb-2 font-sans">Tu bolsa de compra está vacía</p>
          <p class="text-gray-500 mb-8">Descubre nuestros productos más deseados.</p>
           <a href="/productos" class="inline-block border-b border-black text-black font-bold uppercase tracking-widest text-xs pb-1 hover:text-beauty-red hover:border-beauty-red transition-colors">
            Explorar Novedades
          </a>
        </div>
      `;
    } else {
      if (checkoutSection) checkoutSection.style.display = 'block';
      
      let subtotal = 0;
      if (items && items.length > 0) {
        subtotal = items.reduce((sum, item) => {
          if (item?.product?.price && item?.quantity) {
            return sum + (item.product.price * item.quantity);
          }
          return sum;
        }, 0);
      }
      
      const total = calculateTotal();
      
      container.innerHTML = `
        <div class="bg-white">
          <h2 class="text-sm font-bold uppercase tracking-widest mb-6 border-b border-black pb-2">Resumen de tu bolsa (${items.length})</h2>
          <div class="space-y-8">
            ${items.map((item) => `
              <div class="flex items-start space-x-6 pb-8 border-b border-gray-100 last:border-0">
                <a href="/productos" class="block w-24 h-24 bg-gray-100 flex-shrink-0">
                    <img
                    src="${item.product.images[0] || '/placeholder-product.jpg'}"
                    alt="${item.product.name}"
                    class="w-full h-full object-cover mix-blend-multiply"
                    />
                </a>
                <div class="flex-1">
                  <div class="flex justify-between items-start">
                    <div>
                        <h3 class="font-bold text-sm text-black uppercase tracking-wide mb-1">${item.product.name}</h3>
                        <p class="text-xs text-gray-500 mb-2">Ref: ${item.product.slug}</p>
                    </div>
                    <p class="text-sm font-bold text-black">${formatPrice(item.product.price * item.quantity)}</p>
                  </div>
                  <div class="flex justify-between items-end mt-4">
                     <p class="text-xs text-gray-600">Cantidad: ${item.quantity}</p>
                     <button onclick="window.location.href='/productos'" class="text-xs text-gray-400 underline hover:text-black">Editar</button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
          
          <div class="space-y-2 mt-8 pt-6 border-t border-black">
            <div class="flex justify-between text-sm text-gray-600">
              <span>Subtotal</span>
              <span class="font-semibold">${formatPrice(subtotal)}</span>
            </div>
            ${coupon && coupon.code && coupon.discount_amount && coupon.discount_amount > 0 ? `
              <div class="flex justify-between text-sm text-green-600">
                <span>Descuento (${coupon.code})</span>
                <span class="font-semibold">-${formatPrice(coupon.discount_amount)}</span>
              </div>
            ` : ''}
            <div class="flex justify-between items-center text-lg font-bold">
              <span class="uppercase tracking-widest text-sm">Total Estimado</span>
              <span>${formatPrice(total)}</span>
            </div>
          </div>
        </div>
      `;
    }
  }

  // Subscribe to changes
  cartItemsArray.subscribe(() => renderCart());
  appliedCoupon.subscribe(() => renderCart());
  
  // Initial render
  renderCart();
</script>

</PublicLayout>
