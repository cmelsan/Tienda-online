---
import PublicLayout from '@/layouts/PublicLayout.astro';
import ProductGallery from '@/components/product/ProductGallery.astro';
import ProductCard from '@/components/product/ProductCard.astro';
import AddToCartButton from '@/components/islands/AddToCartButton';
import { supabase } from '@/lib/supabase';
import { formatPrice, getStockLabel } from '@/lib/utils';

export async function getStaticPaths() {
  const { data: products } = await supabase
    .from('products')
    .select('slug');

  return products?.map((product) => ({
    params: { slug: product.slug },
  })) || [];
}

const { slug } = Astro.params;

// Fetch product data
const { data: product } = await supabase
  .from('products')
  .select('*, category:categories(*)')
  .eq('slug', slug)
  .single();

if (!product) {
  return Astro.redirect('/404');
}

// Map category slug to fallback image for related products
const getFallbackImage = (categorySlug: string) => {
  return `/assets/products/${
    categorySlug === 'maquillaje' ? 'makeup-default.png' :
    categorySlug === 'cabello' ? 'hair-default.png' :
    categorySlug === 'cuerpo' ? 'body-default.png' :
    categorySlug === 'perfumes' ? 'perfume-default.png' :
    'makeup-default.png'
  }`;
};

// Fetch related products
const { data: relatedProducts } = await supabase
  .from('products')
  .select('*')
  .eq('category_id', product.category_id)
  .neq('id', product.id)
  .limit(4);
---

<PublicLayout
  title={`${product.name} - ÉCLAT`}
  description={product.description}
>
  <div class="max-w-[1920px] mx-auto px-4 sm:px-6 lg:px-12 py-8 lg:py-16">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-y-12 lg:gap-x-16 xl:gap-x-24">
      
      <!-- Left Column: Gallery (Sticky on Desktop) -->
      <div class="lg:col-span-7 xl:col-span-7">
        <div class="lg:sticky lg:top-32">
          {product.images && product.images.length > 0 ? (
             <ProductGallery images={product.images} productName={product.name} />
          ) : (
            <div class="aspect-[4/5] bg-gray-100 flex items-center justify-center text-gray-400">
               <span class="sr-only">Sin imagen</span>
               <svg class="w-20 h-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            </div>
          )}
        </div>
      </div>

      <!-- Right Column: Info (Sticky) -->
      <div class="lg:col-span-5 xl:col-span-4 relative">
        <div class="lg:sticky lg:top-32 space-y-8">
          <!-- Header -->
          <div class="border-b border-black/10 pb-8">
            <nav class="flex items-center text-xs text-gray-500 mb-6 uppercase tracking-widest font-medium">
               <a href="/" class="hover:text-black transition-colors">Inicio</a>
               <span class="mx-2">/</span>
               <a href={`/categoria/${product.category.slug}`} class="hover:text-black transition-colors">{product.category.name}</a>
            </nav>

            <div class="flex items-start justify-between gap-4" x-data="{ 
                  isWishlisted: false,
                  loading: false,
                  init() {
                     if (window.userWishlist && window.userWishlist.includes('${product.id}')) {
                         this.isWishlisted = true;
                     }
                     window.addEventListener('wishlist-ready', () => {
                         if (window.userWishlist && window.userWishlist.includes('${product.id}')) {
                             this.isWishlisted = true;
                         }
                     });
                  },
                  async toggle() {
                      if (this.loading) return;
                      this.loading = true;
                      this.isWishlisted = !this.isWishlisted;
                      try {
                         const res = await fetch('/api/wishlist', {
                             method: 'POST',
                             headers: {'Content-Type': 'application/json'},
                             body: JSON.stringify({ productId: '${product.id}' })
                         });
                         if (!res.ok) {
                             this.isWishlisted = !this.isWishlisted;
                             if (res.status === 401) window.location.href = '/login';
                         } else {
                             if (this.isWishlisted) {
                                 window.userWishlist = [...(window.userWishlist || []), '${product.id}'];
                             } else {
                                 window.userWishlist = (window.userWishlist || []).filter(id => id !== '${product.id}');
                             }
                         }
                      } catch (e) {
                         this.isWishlisted = !this.isWishlisted;
                      } finally {
                         this.loading = false;
                      }
                  }
              }">
                <h1 class="text-4xl lg:text-5xl font-bold tracking-tight text-black mb-4 leading-tight">
                  {product.name}
                </h1>
                
                <button 
                  @click="toggle()"
                  class="flex-shrink-0 p-3 rounded-full border border-gray-200 hover:border-rose-200 hover:bg-rose-50 text-gray-400 hover:text-rose-500 transition-all duration-200"
                  :class="{ 'text-rose-500 bg-rose-50 border-rose-200': isWishlisted }"
                  aria-label="Añadir a lista de deseos"
                >
                  <svg 
                    class="w-6 h-6" 
                    :fill="isWishlisted ? 'currentColor' : 'none'" 
                    stroke="currentColor" 
                    viewBox="0 0 24 24"
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                  </svg>
                </button>
            </div>
            
            <div class="flex items-center justify-between">
                <p class="text-2xl font-medium text-black">
                {formatPrice(product.price)}
                </p>
                {product.stock > 0 && product.stock <= 5 && (
                    <span class="text-xs font-bold text-red-600 bg-red-50 px-2 py-1 uppercase tracking-wider">
                        ¡Últimas {product.stock} unidades!
                    </span>
                )}
            </div>
          </div>

          <!-- Description Short -->
          <div class="prose prose-sm text-gray-600 max-w-none font-light leading-relaxed">
            <p>{product.description}</p>
          </div>

          <!-- Mock Shade/Size Selector if applicable (Visual only for now) -->
          {product.category.slug === 'maquillaje' && (
             <div>
                <span class="text-xs font-bold text-black uppercase tracking-widest block mb-3">Tono</span>
                <div class="flex flex-wrap gap-3">
                    {['#f3cfb3', '#dcbfa4', '#cba082', '#a07153'].map((color, i) => (
                        <button class={`w-10 h-10 rounded-full border border-gray-200 hover:scale-110 transition-transform focus:outline-none focus:ring-2 focus:ring-black focus:ring-offset-2 ${i === 0 ? 'ring-2 ring-black ring-offset-2' : ''}`} style={`background-color: ${color}`} aria-label={`Tono ${i+1}`}></button>
                    ))}
                </div>
             </div>
          )}

          <!-- Add to Cart System -->
          <div class="pt-6">
             <AddToCartButton product={product} client:visible />
             
             {/* Trust Badges */}
             <div class="grid grid-cols-2 gap-4 mt-8 pt-8 border-t border-gray-100">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 13l4 4L19 7"/></svg>
                    <span class="text-xs font-bold uppercase tracking-wider">Envío Gratis +39€</span>
                </div>
                 <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                    <span class="text-xs font-bold uppercase tracking-wider">Devolución Gratis</span>
                </div>
             </div>
          </div>

          <!-- Accordions -->
          <div class="border-t border-black pt-2">
             {[
                { title: 'Descripción', content: product.description },
                { title: 'Ingredientes', content: 'Aqua, Glycerin, Dimethicone, Squalane, Vitamin E. (Lista simulada)' },
                { title: 'Envío & Devoluciones', content: 'Envío estándar gratuito para pedidos superiores a 39€. Entrega en 2-3 días laborables.' }
             ].map((item) => (
                <details class="group border-b border-gray-200 cursor-pointer">
                    <summary class="flex items-center justify-between py-6 list-none hover:text-beauty-red transition-colors">
                        <span class="text-sm font-bold uppercase tracking-widest text-black group-hover:text-beauty-red transition-colors">{item.title}</span>
                        <span class="text-xl font-light transform transition-transform duration-300 group-open:rotate-45">+</span>
                    </summary>
                    <div class="pb-6 text-sm text-gray-600 leading-relaxed font-light animate-fadeIn">
                        {item.content}
                    </div>
                </details>
             ))}
          </div>
        </div>
      </div>
    </div>

    <!-- Related Products -->
    {relatedProducts && relatedProducts.length > 0 && (
      <section class="mt-32 pt-20 border-t border-black">
        <div class="flex items-center justify-between mb-12">
            <h2 class="text-3xl lg:text-4xl font-bold tracking-tight text-black">
            Te puede interesar
            </h2>
            <a href={`/categoria/${product.category.slug}`} class="hidden sm:block text-sm font-bold uppercase tracking-widest border-b border-black pb-1 hover:text-beauty-red hover:border-beauty-red transition-colors">
                Ver todo {product.category.name}
            </a>
        </div>
        
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-12">
          {relatedProducts.map((relatedProduct) => (
            <ProductCard 
              product={{
                  ...relatedProduct,
                   // Fallback for missing brand join if it wasn't fetched in related query (it wasn't in original code)
                   // But ProductCard expects 'brand' string optionally or it just shows 'Marca'
                   brand: 'ÉCLAT' 
              }} 
              fallbackImage={getFallbackImage(product.category.slug)}
            />
          ))}
        </div>
      </section>
    )}
  </div>
</PublicLayout>
